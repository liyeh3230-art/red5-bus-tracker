<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç´…5å…¬è»Š (Red 5) - æ–‡åŒ–å¤§å­¸è‡³æ·é‹åŠæ½­ç«™ è¡Œè»Šæ™‚é–“åˆ†æ</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        .status-dot {
            height: 12px;
            width: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-green { background-color: #10B981; box-shadow: 0 0 8px #10B981; }
        .status-yellow { background-color: #F59E0B; box-shadow: 0 0 8px #F59E0B; }
        .status-red { background-color: #EF4444; box-shadow: 0 0 8px #EF4444; }
        
        /* Custom Scrollbar for logs */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-3 md:p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-6 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-slate-800 flex items-center gap-3">
                        <span class="bg-red-600 text-white px-3 py-1 rounded-lg text-lg">ç´…5</span>
                        è¡Œé§›æ™‚é–“å³æ™‚ç›£æ¸¬
                    </h1>
                    <p class="text-slate-500 mt-2 flex items-center gap-2 text-sm md:text-base">
                        <span class="font-bold text-slate-700">æ–‡åŒ–å¤§å­¸</span> 
                        <span class="text-slate-400">â”</span> 
                        <span class="font-bold text-slate-700">æ·é‹åŠæ½­ç«™</span>
                    </p>
                </div>
                <div class="flex flex-col items-end gap-2">
                    <div class="flex items-center gap-2">
                        <div class="flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-full border border-slate-200">
                            <span id="connection-status" class="status-dot status-yellow"></span>
                            <span id="status-text" class="text-xs font-bold text-slate-600">é€£ç·šåˆå§‹åŒ–...</span>
                        </div>
                        <div class="bg-blue-50 px-3 py-1.5 rounded-full border border-blue-100 text-xs text-blue-600 font-mono">
                            å³æ™‚æ›´æ–°: <span id="last-updated-time">--:--:--</span>
                        </div>
                    </div>
                    <div class="text-xs text-slate-400">
                        è³‡æ–™ä¾†æº: pda5284.gov.taipei (æ¯5ç§’æ›´æ–°)
                    </div>
                </div>
            </div>
        </header>

        <!-- Stats Dashboard -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-blue-500">
                <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider">æ­£åœ¨è¿½è¹¤</h3>
                <div class="flex items-baseline gap-1 mt-2">
                    <p class="text-3xl font-bold text-slate-800" id="tracking-count">0</p>
                    <span class="text-xs text-slate-500">è¼›</span>
                </div>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-green-500">
                <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider">å¹³å‡è€—æ™‚</h3>
                <div class="flex items-baseline gap-1 mt-2">
                    <p class="text-3xl font-bold text-green-600" id="avg-time">--</p>
                    <span class="text-xs text-slate-500">åˆ†</span>
                </div>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-purple-500">
                <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider">æœ€å¿« / æœ€æ…¢</h3>
                <div class="flex items-baseline gap-1 mt-2">
                    <p class="text-xl font-bold text-slate-800" id="min-max-time">-- / --</p>
                    <span class="text-xs text-slate-500">åˆ†</span>
                </div>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-orange-500">
                <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider">å·²è¨˜éŒ„æ¨£æœ¬</h3>
                <div class="flex items-baseline gap-1 mt-2">
                    <p class="text-3xl font-bold text-slate-800" id="sample-count">0</p>
                    <span class="text-xs text-slate-500">ç­†</span>
                </div>
            </div>
        </div>

        <!-- How it Works -->
        <div class="mb-6 bg-slate-800 rounded-xl p-4 border border-slate-700 text-slate-300 shadow-lg">
            <h3 class="text-sm font-bold text-blue-400 mb-3 flex items-center gap-2">
                <span class="text-lg">ğŸ”¬</span> ç³»çµ±é‹ä½œåŸç†
            </h3>
            <div class="grid md:grid-cols-2 gap-4 text-xs">
                <div class="space-y-2">
                    <div class="flex items-start gap-2">
                        <span class="bg-blue-900 text-blue-300 rounded px-1.5 font-mono">1</span>
                        <span>æ¯ 5 ç§’é€é CORS ä»£ç†å¾ <strong>pda5284.gov.taipei</strong> æ“·å–å…¬è»Šå‹•æ…‹</span>
                    </div>
                    <div class="flex items-start gap-2">
                        <span class="bg-blue-900 text-blue-300 rounded px-1.5 font-mono">2</span>
                        <span>ç•¶åµæ¸¬åˆ°è»Šè¼›ç¶“é<strong class="text-white">ã€Œæ–‡åŒ–å¤§å­¸ã€(#11073)</strong>ï¼Œè‡ªå‹•å»ºç«‹è¿½è¹¤æª”æ¡ˆ</span>
                    </div>
                    <div class="flex items-start gap-2">
                        <span class="bg-blue-900 text-blue-300 rounded px-1.5 font-mono">3</span>
                        <span>å³æ™‚æ›´æ–°è»Šè¼›ä½ç½®ï¼Œä¸¦åœ¨åˆ—è¡¨ä¸­é¡¯ç¤ºç›®å‰æ‰€åœ¨ç«™é»</span>
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="flex items-start gap-2">
                        <span class="bg-green-900 text-green-300 rounded px-1.5 font-mono">4</span>
                        <span>ç•¶è»Šè¼›æŠµé”<strong class="text-white">ã€Œæ·é‹åŠæ½­ç«™ã€(#11121)</strong>ï¼Œè§¸ç™¼çµç®—æ©Ÿåˆ¶</span>
                    </div>
                    <div class="flex items-start gap-2">
                        <span class="bg-green-900 text-green-300 rounded px-1.5 font-mono">5</span>
                        <span>ç²¾ç¢ºè¨ˆç®—ï¼š<span class="font-mono text-yellow-400">ç¸½è€—æ™‚ = åˆ°ç«™æ™‚é–“ - èµ·ç«™æ™‚é–“</span></span>
                    </div>
                    <div class="flex items-start gap-2">
                        <span class="bg-green-900 text-green-300 rounded px-1.5 font-mono">6</span>
                        <span>å°‡æ•¸æ“šå¯«å…¥æ­·å²è¨˜éŒ„ï¼Œä¸¦æ›´æ–°å¹³å‡æ™‚é–“çµ±è¨ˆ</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Active Tracking Column -->
            <div class="lg:col-span-1 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col h-[600px]">
                <div class="p-4 border-b border-slate-100 bg-slate-50 rounded-t-xl flex justify-between items-center">
                    <h2 class="font-bold text-slate-700">è·¯ç·šå¯¦æ™‚å‹•æ…‹</h2>
                    <button id="reset-data-btn" class="text-xs text-red-500 hover:underline px-2">æ¸…é™¤è³‡æ–™</button>
                </div>
                <div class="p-4 flex-1 overflow-y-auto custom-scrollbar" id="active-bus-list">
                    <!-- Active buses will be injected here -->
                    <div class="text-center text-slate-400 mt-10">
                        <p class="mb-2">ç­‰å¾…è³‡æ–™æ›´æ–°ä¸­...</p>
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
                    </div>
                </div>
                <div class="p-3 bg-slate-50 border-t border-slate-200 text-xs text-slate-500 text-center">
                    é¡¯ç¤ºå…¨ç·šè¡Œé§›è»Šè¼›ï¼Œä¸¦è‡ªå‹•åˆ†æç›®æ¨™è·¯æ®µè€—æ™‚
                </div>
            </div>

            <!-- Completed Logs Column -->
            <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col h-[600px]">
                <div class="p-4 border-b border-slate-100 bg-slate-50 rounded-t-xl flex justify-between items-center">
                    <h2 class="font-bold text-slate-700">ğŸ“‹ å®Œæˆè¡Œé§›è¨˜éŒ„</h2>
                    <div class="flex gap-2">
                        <button id="export-btn" class="text-xs bg-green-100 text-green-700 hover:bg-green-200 px-3 py-1 rounded border border-green-200 flex items-center gap-1">
                            <span>ğŸ“¥</span> åŒ¯å‡ºCSV
                        </button>
                        <button id="toggle-debug-btn" class="text-xs bg-slate-200 hover:bg-slate-300 px-2 py-1 rounded text-slate-600">æ—¥èªŒ</button>
                    </div>
                </div>
                <div class="flex-1 overflow-hidden flex flex-col">
                    <!-- Completed Table Header -->
                    <div class="grid grid-cols-5 bg-slate-100 text-xs font-bold text-slate-500 py-2 px-4 border-b border-slate-200">
                        <div>è»Šè™Ÿ</div>
                        <div>ç¶“éèµ·é»</div>
                        <div>æŠµé”çµ‚é»</div>
                        <div>ç¸½è€—æ™‚</div>
                        <div>æ—¥æœŸ</div>
                    </div>
                    <!-- Completed Table Body -->
                    <div class="overflow-y-auto custom-scrollbar flex-1" id="completed-log-body">
                        <div class="p-8 text-center text-slate-400 text-sm" id="empty-completed-msg">
                            å°šæœªæœ‰å®Œæˆçš„è¡Œè»Šè¨˜éŒ„
                        </div>
                    </div>
                </div>
                
                <!-- Debug Log (Hidden by default) -->
                <div id="debug-log-container" class="hidden h-48 border-t-2 border-slate-300 bg-slate-900 text-green-400 font-mono text-xs p-4 overflow-y-auto">
                    <div class="mb-1 opacity-50">--- ç³»çµ±æ—¥èªŒé–‹å§‹ ---</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const CONFIG = {
            API_URL: 'https://pda5284.gov.taipei/MQS/SubRouteDyna?csvsubrouteid=158420',
            PROXIES: [
                'https://api.allorigins.win/raw?url=',
                'https://corsproxy.io/?',
                'https://cors-anywhere.herokuapp.com/'
            ],
            POLLING_INTERVAL: 5000,
            START_STOP_ID: '11073', // æ–‡åŒ–å¤§å­¸
            END_STOP_ID: '11121',   // æ·é‹åŠæ½­ç«™
        };
        
        // Full Stop Map
        const STOPS = {
            '174781': 'é™½æ˜å±±ç¸½ç«™',
            '11053': 'é™½æ˜å±±',
            '125818': 'ä¸­å±±æ¨“',
            '11057': 'æ•™å¸«ä¸­å¿ƒ',
            '11059': 'è¯å‹¤é™½æ˜å±±æ‹›å¾…æ‰€',
            '11061': 'ç¦å£½æ©‹',
            '11063': 'æ ¼è‡´å¤§äº¨è·¯å£',
            '11065': 'ç£ºæºªåº•',
            '58228': 'æ–‡åŒ–å¤§å­¸ä¸€',
            '11071': 'é™½æ˜å¤©ä¸»å ‚',
            '11073': 'æ–‡åŒ–å¤§å­¸',
            '11075': 'å±±ä»”åæ´¾å‡ºæ‰€',
            '11077': 'æ ¼è‡´åœ‹ä¸­',
            '11079': 'ä¸‹ç«¹æ—',
            '11081': 'æ–°å®‰',
            '11083': 'ç™½é›²å±±èŠ',
            '11085': 'æ˜å¾·æ–°æ‘',
            '11087': 'é™½æ˜å±±åœ‹å°',
            '11089': 'ç¦éŸ³',
            '11091': 'é™½æ˜æ•™é¤Šé™¢',
            '11093': 'æ°¸ç¦(æ—èªå ‚æ•…å±…)',
            '11095': 'æ°¸å¶º',
            '11097': 'æ‹”å­åŸ”',
            '11099': 'å¶ºé ­',
            '11101': 'è¯èˆˆä¸­å­¸',
            '11103': 'èŠè˜­æ–°æ‘',
            '11105': 'å²©å±±é‡Œä¸€',
            '11107': 'å²©å±±é‡Œ',
            '11109': 'æ³°åŒ—ä¸­å­¸',
            '11111': 'å£«æ—å®˜é‚¸(ä¸­æ­£)',
            '11113': 'ç¦æ—åœ‹å°',
            '11115': 'æ·é‹å£«æ—ç«™(ä¸­å±±)',
            '11117': 'å°é›»å°åŒ—åŒ—å€ç‡Ÿæ¥­è™•',
            '11119': 'éŠ˜å‚³å¤§å­¸',
            '11121': 'æ·é‹åŠæ½­ç«™(ä¸­å±±)',
        };
        
        // Add stop ID map specifically for Route 10821 which might use different IDs or logic
        // The current logic uses STOPS for display mapping.

        // --- State Management ---
        let appState = {
            allBuses: [], // List of { plate, stopName, stopId, status, lastUpdate }
            activeVehicles: {}, // Map: plate -> { startTime, startStop, lastUpdate }
            completedTrips: [], // Array: { plate, startTime, endTime, duration, date }
            lastFetchTime: null,
            connectionStatus: 'init',
            proxyIndex: 0,
        };

        // --- DOM Elements ---
        const els = {
            statusDot: document.getElementById('connection-status'), // Ensure this ID matches HTML
            statusText: document.getElementById('status-text'),
            activeList: document.getElementById('active-bus-list'),
            completedList: document.getElementById('completed-log-body'),
            emptyMsg: document.getElementById('empty-completed-msg'),
            trackingCount: document.getElementById('tracking-count'),
            avgTime: document.getElementById('avg-time'),
            minMaxTime: document.getElementById('min-max-time'),
            sampleCount: document.getElementById('sample-count'),
            debugLog: document.getElementById('debug-log-container'),
            resetBtn: document.getElementById('reset-data-btn'),
            toggleDebugBtn: document.getElementById('toggle-debug-btn'),
            lastUpdated: document.getElementById('last-updated-time')
        };

        // --- Initialization ---
        function init() {
            loadData();
            log("ç³»çµ±å•Ÿå‹•", `åˆå§‹åŒ–ç›£æ¸¬: ${STOPS[CONFIG.START_STOP_ID]} âœ ${STOPS[CONFIG.END_STOP_ID]}`);
            fetchData();
            setInterval(fetchData, CONFIG.POLLING_INTERVAL);
            render();
        }

        // --- Data Persistence ---
        function saveData() {
            localStorage.setItem('red5_tracker_completed', JSON.stringify(appState.completedTrips));
            localStorage.setItem('red5_tracker_active', JSON.stringify(appState.activeVehicles));
        }

        function loadData() {
            const savedCompleted = localStorage.getItem('red5_tracker_completed');
            const savedActive = localStorage.getItem('red5_tracker_active');
            if (savedCompleted) appState.completedTrips = JSON.parse(savedCompleted);
            if (savedActive) appState.activeVehicles = JSON.parse(savedActive);
            
            // Clean up stale active vehicles (> 90 mins)
            const now = Date.now();
            for (let plate in appState.activeVehicles) {
                if (now - appState.activeVehicles[plate].lastUpdate > 5400000) {
                    delete appState.activeVehicles[plate];
                }
            }
        }

        els.resetBtn.addEventListener('click', () => {
            if(confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ­·å²è¨˜éŒ„å—ï¼Ÿ')) {
                appState.completedTrips = [];
                appState.activeVehicles = {};
                saveData();
                render();
            }
        });

        els.toggleDebugBtn.addEventListener('click', () => {
            els.debugLog.classList.toggle('hidden');
        });

        const exportBtn = document.getElementById('export-btn');
        if (exportBtn) {
            exportBtn.addEventListener('click', () => {
                const trips = appState.completedTrips;
                if (trips.length === 0) {
                    alert('ç›®å‰æ²’æœ‰è³‡æ–™å¯ä¾›åŒ¯å‡º');
                    return;
                }
                
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
                csvContent += "è»Šè™Ÿ,ç¶“éèµ·é»,æŠµé”çµ‚é»,ç¸½è€—æ™‚(åˆ†),æ—¥æœŸ\n";
                
                trips.forEach(t => {
                    const start = new Date(t.startTime).toLocaleTimeString();
                    const end = new Date(t.endTime).toLocaleTimeString();
                    csvContent += `${t.plate},${start},${end},${t.duration},${t.date}\n`;
                });
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `bus_red5_data_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }

        // --- Core Logic: Fetching & Parsing ---
        async function fetchData() {
            setConnectionStatus('loading');
            
            const proxy = CONFIG.PROXIES[appState.proxyIndex];
            // Ensure URL is encoded properly for proxy
            const url = proxy + encodeURIComponent(CONFIG.API_URL);

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                let data = await response.json();
                
                // AllOrigins wraps the response
                if (data.contents) {
                    try {
                        data = JSON.parse(data.contents);
                    } catch(e) {
                        // Sometimes it's already an object if not double encoded
                    }
                }

                if (!data || !data.SubRoute) {
                    throw new Error("Invalid JSON format");
                }

                processBusData(data);
                
                setConnectionStatus('success');
                appState.lastFetchTime = new Date();
                if(els.lastUpdated) els.lastUpdated.textContent = appState.lastFetchTime.toLocaleTimeString();
            } catch (error) {
                console.error("Fetch error:", error);
                log("é€£ç·šéŒ¯èª¤", `Proxy ${appState.proxyIndex} å¤±æ•—: ${error.message}`);
                
                appState.proxyIndex = (appState.proxyIndex + 1) % CONFIG.PROXIES.length;
                
                if (appState.proxyIndex === 0) {
                     setConnectionStatus('error');
                     log("ç³»çµ±æç¤º", "æ‰€æœ‰é€£ç·šå¤±æ•—ï¼Œå•Ÿç”¨æ¨¡æ“¬æ¨¡å¼");
                     simulateData();
                     if(els.lastUpdated) els.lastUpdated.textContent = new Date().toLocaleTimeString();
                }
            }
        }

        function processBusData(data) {
            const now = Date.now();
            const buses = [];

            if (data.SubRoute) {
                data.SubRoute.forEach(sub => {
                    if (sub.Bus) {
                        sub.Bus.forEach(bus => {
                            if (bus.a2) {
                                const parts = bus.a2.split(',');
                                // a2 format: A2,RouteID,UniqueId,Type,Progress,SubRouteId,?,StopId,Status,...
                                if (parts.length > 8) {
                                    const stopId = parts[7];
                                    // Use provided timestamp if available in a2 (index 11 usually) or fallback to now
                                    // a2[11] is time in YYMMDDHHmmss format usually
                                    let busTime = now;
                                    if (parts.length > 11 && parts[11].length === 12) {
                                        const t = parts[11];
                                        busTime = new Date(`20${t.substring(0,2)}-${t.substring(2,4)}-${t.substring(4,6)}T${t.substring(6,8)}:${t.substring(8,10)}:${t.substring(10,12)}`).getTime();
                                    }

                                    buses.push({
                                        plate: bus.num,
                                        stopId: stopId,
                                        stopName: STOPS[stopId] || `æœªçŸ¥ç«™é»(${stopId})`,
                                        timestamp: busTime
                                    });
                                }
                            }
                        });
                    }
                });
            }

            appState.allBuses = buses;
            
            // Update Tracking
            buses.forEach(bus => {
                const plate = bus.plate;
                
                // 1. Start Tracking
                if (bus.stopId == CONFIG.START_STOP_ID) {
                    if (!appState.activeVehicles[plate]) {
                        log("è»Šè¼›åµæ¸¬", `ç™¼ç¾è»Šè¼› ${plate} ç¶“é ${STOPS[CONFIG.START_STOP_ID]}`);
                        appState.activeVehicles[plate] = {
                            startTime: bus.timestamp, // Use bus time for accuracy
                            startStop: STOPS[CONFIG.START_STOP_ID],
                            lastUpdate: now,
                            currentStop: bus.stopName
                        };
                    } else {
                        // Update heartbeat
                        appState.activeVehicles[plate].lastUpdate = now;
                        appState.activeVehicles[plate].currentStop = bus.stopName;
                    }
                }
                
                // 2. Update Existing
                if (appState.activeVehicles[plate]) {
                    appState.activeVehicles[plate].lastUpdate = now;
                    appState.activeVehicles[plate].currentStop = bus.stopName;
                    
                    // 3. Complete Trip
                    if (bus.stopId == CONFIG.END_STOP_ID) {
                        const trip = appState.activeVehicles[plate];
                        const endTime = bus.timestamp;
                        const durationMs = endTime - trip.startTime;
                        const durationMin = (durationMs / 60000).toFixed(1);
                        
                        if (durationMin > 5) {
                            log("è¡Œç¨‹å®Œæˆ", `è»Šè¼› ${plate} æŠµé”çµ‚é»ï¼Œè€—æ™‚ ${durationMin} åˆ†`);
                            appState.completedTrips.unshift({
                                plate: plate,
                                startTime: trip.startTime,
                                endTime: endTime,
                                duration: durationMin,
                                date: new Date().toLocaleString()
                            });
                            saveData();
                        }
                        delete appState.activeVehicles[plate];
                    }
                }
            });
            
            saveData();
            render();
        }

        // --- Simulation Mode (Fallback) ---
        function simulateData() {
            setConnectionStatus('simulating');
            // Keep existing buses
            
            // 1. Spawn new bus occasionally at start
            if (Math.random() > 0.8) {
                const plate = "SIM-" + Math.floor(Math.random() * 999);
                if(!appState.activeVehicles[plate]) {
                    appState.activeVehicles[plate] = {
                        startTime: Date.now(),
                        startStop: STOPS[CONFIG.START_STOP_ID],
                        lastUpdate: Date.now(),
                        currentStop: STOPS[CONFIG.START_STOP_ID]
                    };
                    log("æ¨¡æ“¬", `æ¨¡æ“¬è»Šè¼› ${plate} å‡ºç™¼`);
                }
            }

            appState.allBuses = [];

            // 2. Update existing simulated buses
            for(let plate in appState.activeVehicles) {
                const trip = appState.activeVehicles[plate];
                const elapsed = Date.now() - trip.startTime;
                
                // Simulate movement
                trip.lastUpdate = Date.now();
                trip.currentStop = "è¡Œé§›ä¸­...";
                
                // Finish trip after random time (15-25s for demo speed)
                if(elapsed > 15000 && Math.random() > 0.8) {
                     const duration = (15 + Math.random() * 10).toFixed(1);
                     appState.completedTrips.unshift({
                        plate: plate,
                        startTime: trip.startTime,
                        endTime: Date.now(),
                        duration: duration,
                        date: new Date().toLocaleString()
                    });
                    delete appState.activeVehicles[plate];
                    log("æ¨¡æ“¬", `æ¨¡æ“¬è»Šè¼› ${plate} æŠµé”`);
                } else {
                    // Add to display list
                    appState.allBuses.push({
                        plate: plate,
                        stopName: trip.currentStop,
                        stopId: 'sim',
                        timestamp: Date.now()
                    });
                }
            }
            
            saveData();
            render();
        }

        // --- UI Rendering ---
        function render() {
            // Stats
            const trips = appState.completedTrips;
            els.sampleCount.textContent = trips.length;
            els.trackingCount.textContent = Object.keys(appState.activeVehicles).length;
            
            if (trips.length > 0) {
                const total = trips.reduce((acc, cur) => acc + parseFloat(cur.duration), 0);
                els.avgTime.textContent = (total / trips.length).toFixed(1);
                
                const times = trips.map(t => parseFloat(t.duration));
                els.minMaxTime.textContent = `${Math.min(...times).toFixed(1)} / ${Math.max(...times).toFixed(1)}`;
            }

            // Active List (All Buses)
            els.activeList.innerHTML = '';
            
            // Create a unique list of buses, preferring tracked ones
            const displayMap = new Map();
            appState.allBuses.forEach(b => displayMap.set(b.plate, b));
            
            // Ensure actively tracked buses are shown even if momentarily missed in allBuses (e.g. simulation gap)
            Object.keys(appState.activeVehicles).forEach(plate => {
                if(!displayMap.has(plate)) {
                    const info = appState.activeVehicles[plate];
                    displayMap.set(plate, {
                        plate: plate,
                        stopName: info.currentStop,
                        stopId: 'cached'
                    });
                }
            });

            const sortedBuses = Array.from(displayMap.values()).sort((a, b) => {
                 // Put tracked buses first
                 const aTracked = !!appState.activeVehicles[a.plate];
                 const bTracked = !!appState.activeVehicles[b.plate];
                 if (aTracked && !bTracked) return -1;
                 if (!aTracked && bTracked) return 1;
                 return 0;
            });
            
            if (sortedBuses.length === 0) {
                els.activeList.innerHTML = '<div class="text-center text-slate-400 mt-4 text-sm">ç›®å‰ç·šä¸Šç„¡è»Šè¼›è¡Œé§›</div>';
            } else {
                sortedBuses.forEach(bus => {
                    const trackingInfo = appState.activeVehicles[bus.plate];
                    let statusHtml = '';
                    let cardClass = 'bg-white border-slate-200';
                    
                    if (trackingInfo) {
                        const elapsed = Math.floor((Date.now() - trackingInfo.startTime) / 60000);
                        statusHtml = `
                            <div class="text-right">
                                <div class="text-lg font-bold text-blue-600">${elapsed} <span class="text-xs">åˆ†</span></div>
                                <div class="text-xs text-blue-400">è¨ˆæ™‚ä¸­</div>
                            </div>
                        `;
                        cardClass = 'bg-blue-50 border-blue-300 shadow-sm';
                    } else {
                        statusHtml = `
                            <div class="text-right">
                                <span class="bg-slate-100 text-slate-400 text-xs px-2 py-1 rounded">ä¸€èˆ¬è¡Œé§›</span>
                            </div>
                        `;
                    }

                    const div = document.createElement('div');
                    div.className = `p-3 rounded-lg mb-3 border ${cardClass} flex justify-between items-center transition-all`;
                    div.innerHTML = `
                        <div>
                            <div class="font-bold text-slate-700 flex items-center gap-2">
                                <span class="bg-slate-800 text-white text-xs px-2 py-0.5 rounded">${bus.plate}</span>
                            </div>
                            <div class="text-xs text-slate-500 mt-1">ğŸ“ ${bus.stopName}</div>
                        </div>
                        ${statusHtml}
                    `;
                    els.activeList.appendChild(div);
                });
            }

            // Completed List
            els.completedList.innerHTML = '';
            if (trips.length === 0) {
                els.emptyMsg.style.display = 'block';
            } else {
                els.emptyMsg.style.display = 'none';
                trips.forEach(trip => {
                    const row = document.createElement('div');
                    row.className = 'grid grid-cols-5 text-sm py-3 px-4 border-b border-slate-100 hover:bg-slate-50 transition-colors';
                    row.innerHTML = `
                        <div class="font-medium text-slate-800">${trip.plate}</div>
                        <div class="text-slate-500 text-xs">${formatTime(trip.startTime)}</div>
                        <div class="text-slate-500 text-xs">${formatTime(trip.endTime)}</div>
                        <div class="font-bold text-green-600">${trip.duration}åˆ†</div>
                        <div class="text-slate-400 text-xs">${trip.date.split(' ')[0]}</div>
                    `;
                    els.completedList.appendChild(row);
                });
            }
        }

        function formatTime(ms) {
            const d = new Date(ms);
            return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}:${d.getSeconds().toString().padStart(2,'0')}`;
        }

        function log(type, msg) {
            const time = new Date().toLocaleTimeString();
            const line = document.createElement('div');
            line.className = 'mb-1 border-b border-slate-800 pb-1';
            line.innerHTML = `<span class="text-slate-500">[${time}]</span> <span class="text-yellow-500 font-bold">${type}:</span> <span class="text-slate-300">${msg}</span>`;
            els.debugLog.insertBefore(line, els.debugLog.children[1]);
        }

        function setConnectionStatus(status) {
            appState.connectionStatus = status;
            els.statusDot.className = 'status-dot';
            if (status === 'success') {
                els.statusDot.classList.add('status-green');
                els.statusText.textContent = 'é€£ç·šæ­£å¸¸';
            } else if (status === 'loading') {
                els.statusDot.classList.add('status-yellow');
                els.statusText.textContent = 'æ›´æ–°è³‡æ–™ä¸­...';
            } else if (status === 'error') {
                els.statusDot.classList.add('status-red');
                els.statusText.textContent = 'é€£ç·šå¤±æ•—';
            } else if (status === 'simulating') {
                els.statusDot.classList.add('status-yellow');
                els.statusText.textContent = 'ä½¿ç”¨æ¨¡æ“¬è³‡æ–™';
            }
        }

        // Run
        init();

    </script>
</body>
</html>