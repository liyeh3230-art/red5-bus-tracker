<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç´…5 é›™å‘å³æ™‚ç›£æ¸¬ - æ–‡åŒ–å¤§å­¸ â‡„ æ·é‹åŠæ½­ç«™</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        .scroll-hide::-webkit-scrollbar { display: none; }
        .scroll-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen flex overflow-hidden">

    <!-- Left Sidebar: All Buses -->
    <aside class="w-80 bg-slate-900 text-white flex flex-col shrink-0 z-20 shadow-xl border-r border-slate-800">
        <!-- Header -->
        <div class="p-5 border-b border-slate-800 bg-slate-950">
            <div class="flex items-center gap-3 mb-1">
                <span class="bg-red-600 text-white font-bold px-2 py-0.5 rounded text-sm tracking-wider">ç´…5</span>
                <h1 class="font-bold text-lg">å…¨ç·šå³æ™‚å‹•æ…‹</h1>
            </div>
            <div class="text-xs text-slate-500 flex items-center gap-2">
                <span id="connection-status" class="w-2 h-2 rounded-full bg-emerald-500"></span>
                <span id="last-update-time">é€£ç·šä¸­...</span>
            </div>
        </div>

        <!-- Bus List -->
        <div class="flex-1 overflow-y-auto p-2 scroll-hide" id="all-bus-container">
            
            <!-- Sidebar Downhill Section -->
            <div class="sticky top-0 bg-slate-950/90 backdrop-blur z-10 px-2 py-1.5 mb-2 border-b border-slate-800 flex justify-between items-center">
                <span class="text-xs font-bold text-blue-400">ğŸ“‰ ä¸‹å±± (å¾€åŠæ½­)</span>
                <span class="text-[10px] bg-slate-800 px-1.5 rounded text-slate-400" id="sidebar-down-count">0</span>
            </div>
            <div id="sidebar-down-list" class="space-y-2 mb-6">
                <!-- Dynamic Content -->
            </div>

            <!-- Sidebar Uphill Section -->
            <div class="sticky top-0 bg-slate-950/90 backdrop-blur z-10 px-2 py-1.5 mb-2 border-b border-slate-800 flex justify-between items-center">
                <span class="text-xs font-bold text-orange-400">ğŸ“ˆ ä¸Šå±± (å¾€æ–‡å¤§)</span>
                <span class="text-[10px] bg-slate-800 px-1.5 rounded text-slate-400" id="sidebar-up-count">0</span>
            </div>
            <div id="sidebar-up-list" class="space-y-2">
                <!-- Dynamic Content -->
            </div>

            <div id="sidebar-loading" class="text-center text-slate-600 text-xs py-10">
                æ­£åœ¨æœå°‹è»Šè¼›è¨Šè™Ÿ...
            </div>
        </div>

        <!-- Footer -->
        <div class="p-3 border-t border-slate-800 bg-slate-950 text-[10px] text-slate-600 text-center">
            è³‡æ–™ä¾†æº: è‡ºåŒ—å¸‚å…¬å…±é‹è¼¸è™•
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full relative">
        
        <!-- Top Dashboard -->
        <header class="bg-white border-b border-slate-200 p-6 shadow-sm z-10">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <!-- Card: Downhill -->
                <div class="bg-gradient-to-br from-blue-50 to-white border border-blue-100 rounded-xl p-5 relative overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                    <div class="absolute top-0 right-0 bg-blue-100 text-blue-600 text-[10px] font-bold px-2 py-1 rounded-bl-lg">ä¸‹å±±</div>
                    <div class="flex justify-between items-end">
                        <div>
                            <div class="text-slate-500 text-xs font-bold tracking-wider uppercase mb-1">æ–‡åŒ–å¤§å­¸ â” åŠæ½­ç«™</div>
                            <div class="flex items-baseline gap-1">
                                <span class="text-4xl font-black text-blue-600 tracking-tight" id="down-avg">--</span>
                                <span class="text-sm text-blue-400 font-bold">åˆ†</span>
                            </div>
                            <div class="text-[10px] text-slate-400 mt-1">å¹³å‡è¡Œé§›æ™‚é–“</div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-slate-700" id="down-count">0</div>
                            <div class="text-[10px] text-slate-400">è¡Œé§›ä¸­</div>
                        </div>
                    </div>
                </div>

                <!-- Card: Uphill -->
                <div class="bg-gradient-to-br from-orange-50 to-white border border-orange-100 rounded-xl p-5 relative overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                    <div class="absolute top-0 right-0 bg-orange-100 text-orange-600 text-[10px] font-bold px-2 py-1 rounded-bl-lg">ä¸Šå±±</div>
                    <div class="flex justify-between items-end">
                        <div>
                            <div class="text-slate-500 text-xs font-bold tracking-wider uppercase mb-1">åŠæ½­ç«™ â” æ–‡åŒ–å¤§å­¸</div>
                            <div class="flex items-baseline gap-1">
                                <span class="text-4xl font-black text-orange-600 tracking-tight" id="up-avg">--</span>
                                <span class="text-sm text-orange-400 font-bold">åˆ†</span>
                            </div>
                            <div class="text-[10px] text-slate-400 mt-1">å¹³å‡è¡Œé§›æ™‚é–“</div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-slate-700" id="up-count">0</div>
                            <div class="text-[10px] text-slate-400">è¡Œé§›ä¸­</div>
                        </div>
                    </div>
                </div>

            </div>
        </header>

        <!-- Content Split -->
        <div class="flex-1 grid grid-cols-1 md:grid-cols-2 overflow-hidden bg-slate-50">
            
            <!-- Downhill List -->
            <section class="border-r border-slate-200 flex flex-col h-full">
                <div class="px-4 py-2 bg-slate-100 border-b border-slate-200 text-xs font-bold text-slate-500 flex justify-between sticky top-0">
                    <span>ğŸ“‰ ä¸‹å±±ç›£æ¸¬ä¸­</span>
                    <span class="bg-blue-100 text-blue-600 px-1.5 rounded" id="down-status-badge">0 è»Šè¼›</span>
                </div>
                <div class="flex-1 overflow-y-auto p-4 space-y-3 scroll-hide" id="down-list">
                    <!-- Dynamic -->
                </div>
            </section>

            <!-- Uphill List -->
            <section class="flex flex-col h-full">
                <div class="px-4 py-2 bg-slate-100 border-b border-slate-200 text-xs font-bold text-slate-500 flex justify-between sticky top-0">
                    <span>ğŸ“ˆ ä¸Šå±±ç›£æ¸¬ä¸­</span>
                    <span class="bg-orange-100 text-orange-600 px-1.5 rounded" id="up-status-badge">0 è»Šè¼›</span>
                </div>
                <div class="flex-1 overflow-y-auto p-4 space-y-3 scroll-hide" id="up-list">
                    <!-- Dynamic -->
                </div>
            </section>

        </div>
        
        <!-- Footer Tools -->
        <div class="bg-white border-t border-slate-200 p-2 px-4 flex justify-between items-center shrink-0 text-xs">
            <button id="reset-btn" class="text-slate-400 hover:text-red-500">æ¸…é™¤è³‡æ–™</button>
            <button id="export-btn" class="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-white px-3 py-1.5 rounded transition-colors">
                ğŸ“¥ ä¸‹è¼‰ CSV å ±è¡¨
            </button>
        </div>

    </main>

    <!-- JavaScript Logic -->
    <script>
        // --- Config ---
        const CONFIG = {
            // 0,1 = Downhill | 2,3 = Uphill
            API_URLS: [
                'https://pda5284.gov.taipei/MQS/SubRouteDyna?csvsubrouteid=158420', // ä¸‹å±±
                'https://pda5284.gov.taipei/MQS/SubRouteDyna?csvsubrouteid=157609', // ä¸‹å±±
                'https://pda5284.gov.taipei/MQS/SubRouteDyna?csvsubrouteid=158419', // ä¸Šå±±
                'https://pda5284.gov.taipei/MQS/SubRouteDyna?csvsubrouteid=157610'  // ä¸Šå±±
            ],
            PROXIES: [
                'https://api.allorigins.win/raw?url=',
                'https://corsproxy.io/?',
                'https://cors-anywhere.herokuapp.com/'
            ],
            REFRESH_MS: 5000,
            STOPS: {
                // ä¸‹å±± (æ–‡å¤§ -> åŠæ½­)
                DOWN_START: '11073',
                DOWN_END: '11121',
                // ä¸Šå±± (åŠæ½­ -> æ–‡å¤§)
                UP_START: '11123', 
                UP_END: '11169'
            }
        };

        // æ“´å……ç«™é»å°ç…§è¡¨ä»¥é¡¯ç¤ºä¸­æ–‡
        const STOP_NAMES = {
            // === ğŸ“‰ ä¸‹å±± (å¾€åŠæ½­) ===
            '174781': 'é™½æ˜å±±ç¸½ç«™',
            '11053': 'é™½æ˜å±±',
            '125818': 'ä¸­å±±æ¨“',
            '11057': 'æ•™å¸«ä¸­å¿ƒ',
            '11059': 'è¯å‹¤é™½æ˜å±±æ‹›å¾…æ‰€',
            '11061': 'ç¦å£½æ©‹',
            '11063': 'æ ¼è‡´å¤§äº¨è·¯å£',
            '11065': 'ç£ºæºªåº•',
            '58228': 'æ–‡åŒ–å¤§å­¸ä¸€',
            '11071': 'é™½æ˜å¤©ä¸»å ‚',
            '11073': 'æ–‡åŒ–å¤§å­¸',
            '11075': 'å±±ä»”åæ´¾å‡ºæ‰€',
            '11077': 'æ ¼è‡´åœ‹ä¸­',
            '11079': 'ä¸‹ç«¹æ—',
            '11081': 'æ–°å®‰',
            '11083': 'ç™½é›²å±±èŠ',
            '11085': 'æ˜å¾·æ–°æ‘',
            '11087': 'é™½æ˜å±±åœ‹å°',
            '11089': 'ç¦éŸ³',
            '11091': 'é™½æ˜æ•™é¤Šé™¢',
            '11093': 'æ°¸ç¦(æ—èªå ‚æ•…å±…)',
            '11095': 'æ°¸å¶º',
            '11097': 'æ‹”å­åŸ”',
            '11099': 'å¶ºé ­',
            '11101': 'è¯èˆˆä¸­å­¸',
            '11103': 'èŠè˜­æ–°æ‘',
            '11105': 'å²©å±±é‡Œä¸€',
            '11107': 'å²©å±±é‡Œ',
            '11109': 'æ³°åŒ—ä¸­å­¸',
            '11111': 'å£«æ—å®˜é‚¸(ä¸­æ­£)',
            '11113': 'ç¦æ—åœ‹å°',
            '11115': 'æ·é‹å£«æ—ç«™',
            '11117': 'å°é›»å°åŒ—åŒ—å€ç‡Ÿæ¥­è™•',
            '11119': 'éŠ˜å‚³å¤§å­¸',
            '11121': 'æ·é‹åŠæ½­ç«™',

            // === ğŸ“ˆ ä¸Šå±± (å¾€æ–‡å¤§/é™½æ˜å±±) ===
            '11123': 'æ·é‹åŠæ½­ç«™(åŒ—è—ä¸­å¿ƒ)',
            '11125': 'å°åŒ—è¡—',
            '11051': 'å£«æ—å€è¾²æœƒ',
            '11127': 'æ·é‹å£«æ—ç«™(ä¸­æ­£)',
            '11129': 'ç¦æ—åœ‹å°',
            '11131': 'å£«æ—å®˜é‚¸(ä¸­æ­£)',
            '11133': 'æ³°åŒ—ä¸­å­¸',
            '11135': 'å²©å±±é‡Œ',
            '11137': 'å²©å±±é‡Œä¸€',
            '11139': 'èŠè˜­æ–°æ‘',
            '11141': 'è¯èˆˆä¸­å­¸',
            '11143': 'å¶ºé ­',
            '11145': 'æ‹”å­åŸ”',
            '11147': 'æ°¸å¶º',
            '11149': 'æ°¸ç¦(æ—èªå ‚æ•…å±…)',
            '11151': 'é™½æ˜æ•™é¤Šé™¢',
            '11153': 'ç¦éŸ³',
            '11155': 'é™½æ˜å±±åœ‹å°',
            '11157': 'æ˜å¾·æ–°æ‘',
            '11159': 'ç™½é›²å±±èŠ',
            '11161': 'æ–°å®‰',
            '11163': 'ä¸‹ç«¹æ—',
            '11165': 'æ ¼è‡´åœ‹ä¸­',
            '11167': 'å±±ä»”åæ´¾å‡ºæ‰€',
            '11169': 'æ–‡åŒ–å¤§å­¸',
            '11173': 'æ–‡åŒ–å¤§å­¸ä¸€',
            '11175': 'é™½æ˜å¤©ä¸»å ‚',
            '11177': 'ç£ºæºªåº•',
            '11179': 'æ ¼è‡´å¤§äº¨è·¯å£',
            '11181': 'ç¦å£½æ©‹',
            '11183': 'è¯å‹¤é™½æ˜å±±æ‹›å¾…æ‰€',
            '11055': 'éŒ«å®‰å ‚',
            '11185': 'æ•™å¸«ä¸­å¿ƒ',
            '125817': 'ä¸­å±±æ¨“',
            '57747': 'é™½æ˜å±±',
            '11187': 'é™½æ˜å±±ç¸½ç«™'
        };

        // --- State ---
        let state = {
            // { plate: { type:'down'|'up', startTime, startStop, lastUpdate, currentStop, stopId } }
            tracking: {},
            // [{ type, plate, startTime, endTime, duration, date }]
            completed: [],
            proxyIndex: 0,
            allBuses: [] // List of all raw bus data for sidebar
        };

        // --- DOM ---
        const els = {
            sidebarDownList: document.getElementById('sidebar-down-list'),
            sidebarUpList: document.getElementById('sidebar-up-list'),
            sidebarDownCount: document.getElementById('sidebar-down-count'),
            sidebarUpCount: document.getElementById('sidebar-up-count'),
            sidebarLoading: document.getElementById('sidebar-loading'),
            downList: document.getElementById('down-list'),
            upList: document.getElementById('up-list'),
            downAvg: document.getElementById('down-avg'),
            upAvg: document.getElementById('up-avg'),
            downCount: document.getElementById('down-count'),
            upCount: document.getElementById('up-count'),
            downBadge: document.getElementById('down-status-badge'),
            upBadge: document.getElementById('up-status-badge'),
            statusDot: document.getElementById('connection-status'),
            statusText: document.getElementById('last-update-time'),
            exportBtn: document.getElementById('export-btn'),
            resetBtn: document.getElementById('reset-btn')
        };

        // --- Init ---
        function init() {
            loadData();
            fetchData();
            setInterval(fetchData, CONFIG.REFRESH_MS);

            els.resetBtn.addEventListener('click', () => {
                if(confirm('ç¢ºå®šæ¸…é™¤æ‰€æœ‰è¨˜éŒ„ï¼Ÿ')) {
                    state.tracking = {};
                    state.completed = [];
                    saveData();
                    render();
                }
            });
            els.exportBtn.addEventListener('click', exportCSV);
        }

        // --- Core Logic ---
        async function fetchData() {
            updateStatus('loading');
            
            const busMap = new Map();
            const proxy = CONFIG.PROXIES[state.proxyIndex];

            try {
                // Fetch all URLs parallel
                const promises = CONFIG.API_URLS.map(url => 
                    fetch(proxy + encodeURIComponent(url))
                        .then(r => r.ok ? r.json() : null)
                        .catch(e => null)
                );

                const results = await Promise.all(promises);
                
                let success = false;
                results.forEach((data, index) => {
                    if (data) {
                        // 0,1 = Down | 2,3 = Up
                        const dir = index < 2 ? 'down' : 'up';
                        parseBusData(data, busMap, dir);
                        success = true;
                    }
                });

                if (!success) throw new Error("All sources failed");

                // Update State
                state.allBuses = Array.from(busMap.values());
                updateTracking(state.allBuses);
                
                updateStatus('ok');
                render();

            } catch (e) {
                console.error(e);
                state.proxyIndex = (state.proxyIndex + 1) % CONFIG.PROXIES.length;
                updateStatus('error');
            }
        }

        function parseBusData(data, busMap, direction) {
            if (data.contents) {
                try { data = JSON.parse(data.contents); } catch(e){}
            }
            if (!data.SubRoute) return;

            data.SubRoute.forEach(sub => {
                if (!sub.Bus) return;
                sub.Bus.forEach(bus => {
                    if (!bus.a2) return;
                    // a2 format: ... StopId is index 7
                    const parts = bus.a2.split(',');
                    if (parts.length > 8) {
                        const stopId = parts[7];
                        let busTime = Date.now();
                        
                        // Try parse time
                        if (parts.length > 11 && parts[11].length >= 12) {
                             const t = parts[11]; // YYMMDDHHmmss
                             busTime = new Date(`20${t.substr(0,2)}-${t.substr(2,2)}-${t.substr(4,2)}T${t.substr(6,2)}:${t.substr(8,2)}:${t.substr(10,2)}`).getTime();
                        }

                        // Add to Map (deduplicate by Plate, prefer newer data)
                        const existing = busMap.get(bus.num);
                        if (!existing || busTime > existing.time) {
                            busMap.set(bus.num, {
                                plate: bus.num,
                                stopId: stopId,
                                stopName: STOP_NAMES[stopId] || `ç«™é» ${stopId}`,
                                time: busTime,
                                subRoute: sub.subRouteId,
                                direction: direction
                            });
                        }
                    }
                });
            });
        }

        function updateTracking(currentBuses) {
            const now = Date.now();

            currentBuses.forEach(bus => {
                const plate = bus.plate;
                const stopId = bus.stopId;
                
                // 1. Downhill Start
                if (stopId === CONFIG.STOPS.DOWN_START) {
                    if (!state.tracking[plate] || state.tracking[plate].type !== 'down') {
                        state.tracking[plate] = {
                            type: 'down',
                            startTime: bus.time,
                            startStop: 'æ–‡åŒ–å¤§å­¸',
                            lastUpdate: now,
                            currentStop: bus.stopName
                        };
                    } else {
                        state.tracking[plate].lastUpdate = now;
                        state.tracking[plate].currentStop = bus.stopName;
                    }
                }
                // 2. Uphill Start
                else if (stopId === CONFIG.STOPS.UP_START) {
                    if (!state.tracking[plate] || state.tracking[plate].type !== 'up') {
                        state.tracking[plate] = {
                            type: 'up',
                            startTime: bus.time,
                            startStop: 'æ·é‹åŠæ½­ç«™',
                            lastUpdate: now,
                            currentStop: bus.stopName
                        };
                    } else {
                         state.tracking[plate].lastUpdate = now;
                         state.tracking[plate].currentStop = bus.stopName;
                    }
                }
                
                // 3. Update Active Trips
                if (state.tracking[plate]) {
                    const trip = state.tracking[plate];
                    trip.lastUpdate = now;
                    trip.currentStop = bus.stopName;
                    trip.stopId = stopId;

                    // Finish Downhill
                    if (trip.type === 'down' && stopId === CONFIG.STOPS.DOWN_END) {
                        completeTrip(plate, trip, bus.time);
                    }
                    // Finish Uphill
                    else if (trip.type === 'up' && stopId === CONFIG.STOPS.UP_END) {
                        completeTrip(plate, trip, bus.time);
                    }
                }
            });

            // Cleanup Stale
            for (let plate in state.tracking) {
                if (now - state.tracking[plate].lastUpdate > 1200000) { // 20 mins no signal
                    delete state.tracking[plate];
                }
            }
            saveData();
        }

        function completeTrip(plate, trip, endTime) {
            const duration = ((endTime - trip.startTime) / 60000).toFixed(1);
            if (duration > 5 && duration < 120) {
                state.completed.unshift({
                    type: trip.type,
                    plate: plate,
                    startTime: trip.startTime,
                    endTime: endTime,
                    duration: duration,
                    date: new Date().toLocaleString()
                });
                if (state.completed.length > 100) state.completed.pop();
            }
            delete state.tracking[plate];
        }

        // --- Render ---
        function render() {
            // 1. Left Sidebar (All Buses)
            els.sidebarDownList.innerHTML = '';
            els.sidebarUpList.innerHTML = '';
            els.sidebarLoading.style.display = state.allBuses.length > 0 ? 'none' : 'block';

            const allDown = state.allBuses.filter(b => b.direction === 'down').sort((a,b) => b.time - a.time);
            const allUp = state.allBuses.filter(b => b.direction === 'up').sort((a,b) => b.time - a.time);

            els.sidebarDownCount.textContent = allDown.length;
            els.sidebarUpCount.textContent = allUp.length;

            const createSidebarItem = (bus, isDown) => {
                const isTracking = state.tracking[bus.plate];
                const baseColor = isDown ? 'blue' : 'orange';
                const statusColor = isTracking ? `text-${baseColor}-400` : 'text-slate-500';
                const statusText = isTracking ? 'â±ï¸ è¨ˆæ™‚ä¸­' : 'è¡Œé§›ä¸­';
                const borderColor = isTracking ? `border-${baseColor}-900` : 'border-slate-800';
                
                const div = document.createElement('div');
                div.className = `bg-slate-800/50 p-3 rounded border ${borderColor} flex justify-between items-center hover:bg-slate-800 transition-colors group`;
                div.innerHTML = `
                    <div>
                        <div class="font-mono font-bold text-slate-200 flex items-center gap-2">
                            ${bus.plate}
                            ${isTracking ? `<span class="w-1.5 h-1.5 rounded-full bg-${baseColor}-500 animate-pulse"></span>` : ''}
                        </div>
                        <div class="text-[10px] text-slate-400 truncate max-w-[120px] group-hover:text-slate-300 transition-colors">ğŸ“ ${bus.stopName}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-[10px] ${statusColor} font-bold">${statusText}</div>
                        <div class="text-[9px] text-slate-600 font-mono mt-0.5">${new Date(bus.time).toLocaleTimeString().slice(0,5)}</div>
                    </div>
                `;
                return div;
            };

            allDown.forEach(bus => els.sidebarDownList.appendChild(createSidebarItem(bus, true)));
            allUp.forEach(bus => els.sidebarUpList.appendChild(createSidebarItem(bus, false)));

            // 2. Dashboard Stats
            const downs = state.completed.filter(t => t.type === 'down');
            const ups = state.completed.filter(t => t.type === 'up');
            els.downAvg.textContent = calcAvg(downs);
            els.upAvg.textContent = calcAvg(ups);
            
            const activeDown = [];
            const activeUp = [];
            Object.entries(state.tracking).forEach(([plate, trip]) => {
                if (trip.type === 'down') activeDown.push({plate, ...trip});
                else activeUp.push({plate, ...trip});
            });

            els.downCount.textContent = activeDown.length;
            els.upCount.textContent = activeUp.length;
            els.downBadge.textContent = `${activeDown.length} è»Šè¼›`;
            els.upBadge.textContent = `${activeUp.length} è»Šè¼›`;

            // 3. Tracking Lists
            renderTrackingList(els.downList, activeDown, 'blue');
            renderTrackingList(els.upList, activeUp, 'orange');
        }

        function renderTrackingList(container, list, color) {
            container.innerHTML = '';
            if(list.length === 0) {
                container.innerHTML = `<div class="text-center text-slate-400 text-xs py-10 opacity-50">ç›®å‰ç„¡è»Šè¼›è¡Œé§›æ–¼æ­¤å€æ®µ</div>`;
                return;
            }
            list.sort((a,b) => b.startTime - a.startTime).forEach(bus => {
                const elapsed = Math.floor((Date.now() - bus.startTime) / 60000);
                const div = document.createElement('div');
                div.className = `bg-white p-3 rounded-lg border border-${color}-100 shadow-sm flex justify-between items-center animate-in fade-in slide-in-from-bottom-1`;
                div.innerHTML = `
                    <div>
                        <div class="font-bold text-slate-700">${bus.plate}</div>
                        <div class="text-[11px] text-slate-500 mt-0.5">ğŸ“ ${bus.currentStop}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-mono font-black text-${color}-500 text-xl">${elapsed}<span class="text-[10px] ml-0.5 font-normal text-slate-400">åˆ†</span></div>
                        <div class="text-[9px] text-slate-400">å·²è¡Œé§›</div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function calcAvg(list) {
            if (list.length === 0) return '--';
            const total = list.reduce((sum, t) => sum + parseFloat(t.duration), 0);
            return (total / list.length).toFixed(1);
        }

        function updateStatus(s) {
            const now = new Date().toLocaleTimeString();
            if(s==='ok') {
                els.statusDot.className = 'w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.8)]';
                els.statusText.textContent = `å·²æ›´æ–° ${now}`;
            } else if(s==='loading') {
                els.statusDot.className = 'w-2 h-2 rounded-full bg-amber-500 animate-pulse';
                els.statusText.textContent = 'æ›´æ–°ä¸­...';
            } else {
                els.statusDot.className = 'w-2 h-2 rounded-full bg-rose-500';
                els.statusText.textContent = 'é€£ç·šé‡è©¦ä¸­';
            }
        }

        function saveData() {
            localStorage.setItem('red5_dual_v2', JSON.stringify({
                tracking: state.tracking,
                completed: state.completed
            }));
        }

        function loadData() {
            const raw = localStorage.getItem('red5_dual_v2');
            if (raw) {
                const d = JSON.parse(raw);
                state.tracking = d.tracking || {};
                state.completed = d.completed || [];
            }
        }

        function exportCSV() {
            if (state.completed.length === 0) return alert('ç„¡è³‡æ–™å¯åŒ¯å‡º');
            let csv = "æ–¹å‘,è»Šè™Ÿ,é–‹å§‹æ™‚é–“,çµæŸæ™‚é–“,è€—æ™‚(åˆ†),æ—¥æœŸ\n";
            state.completed.forEach(t => {
                const type = t.type === 'down' ? 'ä¸‹å±±' : 'ä¸Šå±±';
                const start = new Date(t.startTime).toLocaleTimeString();
                const end = new Date(t.endTime).toLocaleTimeString();
                csv += `${type},${t.plate},${start},${end},${t.duration},${t.date}\n`;
            });
            const blob = new Blob(["\uFEFF"+csv], {type: 'text/csv;charset=utf-8;'});
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `ç´…5_è¡Œè»Šè¨˜éŒ„_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }

        init();
    </script>
</body>
</html>