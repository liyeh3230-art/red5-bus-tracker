<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç´…5 é›™å‘å³æ™‚ç›£æ¸¬ - æ–‡åŒ–å¤§å­¸ â‡„ æ·é‹åŠæ½­ç«™</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+TC:wght@400;500;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .scroll-hide::-webkit-scrollbar {
            display: none;
        }

        .scroll-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Timeline Styles */
        .timeline-line {
            position: absolute;
            left: 19px;
            top: 24px;
            bottom: -10px;
            width: 2px;
            background: #e2e8f0;
            z-index: 0;
        }

        .timeline-item:last-child .timeline-line {
            display: none;
        }

        /* Animations */
        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-3px);
            }
        }

        .bus-float {
            animation: float 2s ease-in-out infinite;
        }

        /* Tab Transition */
        .tab-content {
            display: none;
            animation: fadeIn 0.2s ease-in-out;
        }

        .tab-content.active {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobile Safe Area */
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>

<body class="bg-slate-100 text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- 3-Column Layout on Desktop, Tab Layout on Mobile -->
    <div class="flex-1 flex flex-col md:flex-row overflow-hidden relative">

        <!-- 1. SIDEBAR: ROUTE TIMELINE -->
        <aside id="view-route"
            class="tab-content md:flex w-full md:w-[360px] lg:w-[380px] bg-white flex-col shrink-0 z-20 shadow-xl border-r border-slate-200 h-full md:h-auto absolute md:relative inset-0">
            <div class="p-4 border-b border-slate-200 bg-slate-50 shrink-0 sticky top-0 z-30">
                <div class="flex items-center gap-3 mb-3">
                    <span class="bg-red-600 text-white font-bold px-2 py-0.5 rounded text-sm tracking-wider">ç´…5</span>
                    <h1 class="font-bold text-slate-800">è·¯ç·šå‹•æ…‹</h1>
                    <div class="ml-auto md:hidden text-xs text-slate-400" id="mobile-status-text">é€£ç·šä¸­...</div>
                </div>
                <div class="flex p-1 bg-slate-200 rounded-lg">
                    <button onclick="switchSidebar('down')" id="tab-down"
                        class="flex-1 py-2 text-xs font-bold rounded-md transition-all bg-white text-blue-600 shadow-sm">ğŸ“‰
                        ä¸‹å±± (å¾€åŠæ½­)</button>
                    <button onclick="switchSidebar('up')" id="tab-up"
                        class="flex-1 py-2 text-xs font-bold rounded-md transition-all text-slate-500 hover:text-slate-700">ğŸ“ˆ
                        ä¸Šå±± (å¾€æ–‡å¤§)</button>
                </div>
            </div>

            <!-- ä¿®æ­£ï¼šæ‰‹æ©Ÿç‰ˆå¢åŠ åº•éƒ¨é–“è· (pb-24) é˜²æ­¢è¢«å°èˆªåˆ—é®æ“‹ -->
            <div class="flex-1 overflow-y-auto p-0 pb-24 md:pb-0 relative scroll-hide bg-white" id="sidebar-container">
                <div class="p-10 text-center text-slate-400 text-xs">è¼‰å…¥è·¯ç·šè³‡æ–™ä¸­...</div>
            </div>

            <div
                class="p-2 border-t border-slate-200 bg-slate-50 text-[10px] text-slate-500 hidden md:flex justify-between items-center">
                <span id="last-update-time">é€£ç·šä¸­...</span>
                <span id="connection-status" class="flex items-center gap-1"><span
                        class="w-2 h-2 rounded-full bg-emerald-500"></span> é€£ç·šæ­£å¸¸</span>
            </div>
        </aside>

        <!-- 2. MAIN: DASHBOARD -->
        <main id="view-home"
            class="tab-content active md:flex flex-1 flex-col h-full relative bg-slate-50 w-full absolute md:relative inset-0 overflow-y-auto md:overflow-hidden">

            <!-- Stats Cards -->
            <header class="bg-white border-b border-slate-200 p-4 shadow-sm z-10 shrink-0">
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
                    <!-- Downhill Card -->
                    <div
                        class="bg-gradient-to-br from-blue-50 to-white border border-blue-100 rounded-xl p-4 relative overflow-hidden shadow-sm group">
                        <div
                            class="absolute top-0 right-0 bg-blue-100 text-blue-600 text-[10px] font-bold px-3 py-1 rounded-bl-lg">
                            ä¸‹å±±</div>
                        <div class="flex justify-between items-end relative z-10">
                            <div>
                                <div class="text-slate-500 text-xs font-bold tracking-wider uppercase mb-1">æ–‡å¤§ â” åŠæ½­ç«™
                                </div>
                                <div class="flex items-baseline gap-1">
                                    <span class="text-3xl md:text-4xl font-black text-blue-600 tracking-tight"
                                        id="down-avg">--</span>
                                    <span class="text-sm text-blue-400 font-bold">åˆ† (å¹³å‡)</span>
                                </div>
                                <div class="text-[11px] text-slate-500 mt-1">æœ€è¿‘ä¸€ç­: <span id="down-last"
                                        class="font-bold text-blue-600">--</span> åˆ†</div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-slate-700" id="down-count">0</div>
                                <div class="text-[10px] text-slate-400">è¡Œé§›ä¸­</div>
                            </div>
                        </div>
                    </div>
                    <!-- Uphill Card -->
                    <div
                        class="bg-gradient-to-br from-orange-50 to-white border border-orange-100 rounded-xl p-4 relative overflow-hidden shadow-sm group">
                        <div
                            class="absolute top-0 right-0 bg-orange-100 text-orange-600 text-[10px] font-bold px-3 py-1 rounded-bl-lg">
                            ä¸Šå±±</div>
                        <div class="flex justify-between items-end relative z-10">
                            <div>
                                <div class="text-slate-500 text-xs font-bold tracking-wider uppercase mb-1">åŠæ½­ç«™ â” æ–‡å¤§
                                </div>
                                <div class="flex items-baseline gap-1">
                                    <span class="text-3xl md:text-4xl font-black text-orange-600 tracking-tight"
                                        id="up-avg">--</span>
                                    <span class="text-sm text-orange-400 font-bold">åˆ† (å¹³å‡)</span>
                                </div>
                                <div class="text-[11px] text-slate-500 mt-1">æœ€è¿‘ä¸€ç­: <span id="up-last"
                                        class="font-bold text-orange-600">--</span> åˆ†</div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-slate-700" id="up-count">0</div>
                                <div class="text-[10px] text-slate-400">è¡Œé§›ä¸­</div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Lists Split View -->
            <div class="flex-1 flex flex-col xl:flex-row overflow-hidden bg-slate-50 pb-20 md:pb-0">
                <!-- Down List -->
                <section class="flex-1 flex flex-col relative border-b xl:border-b-0 xl:border-r border-slate-200">
                    <div
                        class="px-4 py-2 bg-slate-100/80 backdrop-blur border-b border-slate-200 text-xs font-bold text-slate-500 sticky top-0 z-10">
                        ğŸ“‰ ä¸‹å±±ç›£æ¸¬ (è¡Œé§›ä¸­)</div>
                    <div class="flex-1 overflow-y-auto p-4 space-y-3 scroll-hide" id="down-list"></div>
                </section>
                <!-- Up List -->
                <section class="flex-1 flex flex-col relative">
                    <div
                        class="px-4 py-2 bg-slate-100/80 backdrop-blur border-b border-slate-200 text-xs font-bold text-slate-500 sticky top-0 z-10">
                        ğŸ“ˆ ä¸Šå±±ç›£æ¸¬ (è¡Œé§›ä¸­)</div>
                    <div class="flex-1 overflow-y-auto p-4 space-y-3 scroll-hide" id="up-list"></div>
                </section>
            </div>
        </main>

        <!-- 3. RIGHT: HISTORY LOG -->
        <div id="view-history"
            class="tab-content md:flex flex-1 md:max-w-[400px] flex-col h-full relative bg-white md:border-l border-slate-200 w-full absolute md:relative inset-0 z-30">
            <div
                class="p-4 bg-white border-b border-slate-200 flex justify-between items-center sticky top-0 z-10 shrink-0 h-[73px]">
                <h2 class="font-bold text-lg">ğŸ“œ æ­·å²ç´€éŒ„</h2>
                <button onclick="exportCSV()"
                    class="text-xs bg-slate-800 text-white px-3 py-1.5 rounded hover:bg-slate-700 flex items-center gap-1">
                    <span>ğŸ“¥</span> ä¸‹è¼‰ CSV
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-0 pb-20 md:pb-0 scroll-hide bg-slate-50">
                <table class="w-full text-xs text-left border-collapse">
                    <thead class="bg-slate-100 text-slate-500 font-bold border-b border-slate-200 sticky top-0 z-10">
                        <tr>
                            <th class="p-3">è»Šè™Ÿ</th>
                            <th class="p-3">æ™‚é–“</th>
                            <th class="p-3 text-right">è€—æ™‚</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body" class="divide-y divide-slate-100 bg-white">
                        <!-- Dynamic -->
                    </tbody>
                </table>
                <div id="history-empty" class="p-10 text-center text-slate-400 text-xs hidden">å°šç„¡ç´€éŒ„</div>
            </div>
        </div>

    </div>

    <!-- Mobile Navigation -->
    <nav
        class="md:hidden fixed bottom-0 w-full bg-white border-t border-slate-200 flex justify-around items-center h-16 z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] pb-safe">
        <button onclick="switchTab('home')"
            class="nav-btn flex flex-col items-center justify-center w-full h-full text-blue-600"
            data-target="view-home">
            <span class="text-xl mb-0.5">ğŸ </span>
            <span class="text-[10px] font-bold">å„€è¡¨æ¿</span>
        </button>
        <button onclick="switchTab('route')"
            class="nav-btn flex flex-col items-center justify-center w-full h-full text-slate-400"
            data-target="view-route">
            <span class="text-xl mb-0.5">ğŸ—ºï¸</span>
            <span class="text-[10px] font-bold">è·¯ç·šåœ–</span>
        </button>
        <button onclick="switchTab('history')"
            class="nav-btn flex flex-col items-center justify-center w-full h-full text-slate-400"
            data-target="view-history">
            <span class="text-xl mb-0.5">ğŸ“œ</span>
            <span class="text-[10px] font-bold">æ­·å²ç´€éŒ„</span>
        </button>
    </nav>

    <!-- Logic -->
    <script>
        const CONFIG = {
            API_URLS: [
                'https://pda5284.gov.taipei/MQS/SubRouteDyna?csvsubrouteid=158420',
                'https://pda5284.gov.taipei/MQS/SubRouteDyna?csvsubrouteid=157609',
                'https://pda5284.gov.taipei/MQS/SubRouteDyna?csvsubrouteid=158419',
                'https://pda5284.gov.taipei/MQS/SubRouteDyna?csvsubrouteid=157610'
            ],
            PROXIES: ['https://corsproxy.io/?', 'https://api.allorigins.win/raw?url=', 'https://cors-anywhere.herokuapp.com/'],
            REFRESH_MS: 3000,
            STOPS: { DOWN_START: '11073', DOWN_END: '11121', UP_START: '11123', UP_END: '11169' }
        };

        const TTE_MAP = { '0': 'é€²ç«™ä¸­', '': 'æœªç™¼è»Š', '-1': 'æœªç™¼è»Š', '-2': 'äº¤ç®¡ä¸åœ', '-3': 'æœ«ç­å·²é', '-4': 'ä»Šæ—¥æœªç‡Ÿé‹' };
        const FIRST_STOP_MAP = { "158420": "174781", "157609": "174781", "158419": "134539", "157610": "134539" };
        const STOP_NAMES = {
            '174781': 'é™½æ˜å±±ç¸½ç«™', '11053': 'é™½æ˜å±±', '125818': 'ä¸­å±±æ¨“', '11057': 'æ•™å¸«ä¸­å¿ƒ', '11059': 'è¯å‹¤é™½æ˜å±±æ‹›å¾…æ‰€', '11061': 'ç¦å£½æ©‹', '11063': 'æ ¼è‡´å¤§äº¨è·¯å£', '11065': 'ç£ºæºªåº•',
            '58228': 'æ–‡åŒ–å¤§å­¸ä¸€', '11071': 'é™½æ˜å¤©ä¸»å ‚', '11073': 'æ–‡åŒ–å¤§å­¸', '11075': 'å±±ä»”åæ´¾å‡ºæ‰€', '11077': 'æ ¼è‡´åœ‹ä¸­', '11079': 'ä¸‹ç«¹æ—', '11081': 'æ–°å®‰', '11083': 'ç™½é›²å±±èŠ',
            '11085': 'æ˜å¾·æ–°æ‘', '11087': 'é™½æ˜å±±åœ‹å°', '11089': 'ç¦éŸ³', '11091': 'é™½æ˜æ•™é¤Šé™¢', '11093': 'æ°¸ç¦(æ—èªå ‚æ•…å±…)', '11095': 'æ°¸å¶º', '11097': 'æ‹”å­åŸ”', '11099': 'å¶ºé ­',
            '11101': 'è¯èˆˆä¸­å­¸', '11103': 'èŠè˜­æ–°æ‘', '11105': 'å²©å±±é‡Œä¸€', '11107': 'å²©å±±é‡Œ', '11109': 'æ³°åŒ—ä¸­å­¸', '11111': 'å£«æ—å®˜é‚¸(ä¸­æ­£)', '11113': 'ç¦æ—åœ‹å°', '11115': 'æ·é‹å£«æ—ç«™',
            '11117': 'å°é›»å°åŒ—åŒ—å€ç‡Ÿæ¥­è™•', '11119': 'éŠ˜å‚³å¤§å­¸', '11121': 'æ·é‹åŠæ½­ç«™', '11123': 'æ·é‹åŠæ½­ç«™(åŒ—è—ä¸­å¿ƒ)', '11125': 'å°åŒ—è¡—', '11051': 'å£«æ—å€è¾²æœƒ', '11127': 'æ·é‹å£«æ—ç«™(ä¸­æ­£)',
            '11129': 'ç¦æ—åœ‹å°', '11131': 'å£«æ—å®˜é‚¸(ä¸­æ­£)', '11133': 'æ³°åŒ—ä¸­å­¸', '11135': 'å²©å±±é‡Œ', '11137': 'å²©å±±é‡Œä¸€', '11139': 'èŠè˜­æ–°æ‘', '11141': 'è¯èˆˆä¸­å­¸', '11143': 'å¶ºé ­',
            '11145': 'æ‹”å­åŸ”', '11147': 'æ°¸å¶º', '11149': 'æ°¸ç¦(æ—èªå ‚æ•…å±…)', '11151': 'é™½æ˜æ•™é¤Šé™¢', '11153': 'ç¦éŸ³', '11155': 'é™½æ˜å±±åœ‹å°', '11157': 'æ˜å¾·æ–°æ‘', '11159': 'ç™½é›²å±±èŠ',
            '11161': 'æ–°å®‰', '11163': 'ä¸‹ç«¹æ—', '11165': 'æ ¼è‡´åœ‹ä¸­', '11167': 'å±±ä»”åæ´¾å‡ºæ‰€', '11169': 'æ–‡åŒ–å¤§å­¸', '11173': 'æ–‡åŒ–å¤§å­¸ä¸€', '11175': 'é™½æ˜å¤©ä¸»å ‚', '11177': 'ç£ºæºªåº•',
            '11179': 'æ ¼è‡´å¤§äº¨è·¯å£', '11181': 'ç¦å£½æ©‹', '11183': 'è¯å‹¤é™½æ˜å±±æ‹›å¾…æ‰€', '11055': 'éŒ«å®‰å ‚', '11185': 'æ•™å¸«ä¸­å¿ƒ', '125817': 'ä¸­å±±æ¨“', '57747': 'é™½æ˜å±±', '11187': 'é™½æ˜å±±ç¸½ç«™'
        };

        let state = { tracking: {}, completed: [], proxyIndex: 0, allBuses: [], routeStops: { down: [], up: [] }, activeSidebar: 'down' };

        function init() {
            loadData();
            fetchData();
            setInterval(fetchData, CONFIG.REFRESH_MS);
            if (window.innerWidth >= 768) {
                // Desktop: Show all 3 columns
                document.getElementById('view-route').classList.add('active');
                document.getElementById('view-home').classList.add('active');
                document.getElementById('view-history').classList.add('active');
            } else {
                switchTab('home');
            }
        }

        async function fetchData() {
            updateStatus('loading');
            const proxy = CONFIG.PROXIES[state.proxyIndex];
            const busMap = new Map();
            let fetchedStops = { down: null, up: null };
            try {
                const promises = CONFIG.API_URLS.map(url => fetch(proxy + encodeURIComponent(url)).then(r => r.ok ? r.json() : null).catch(e => null));
                const results = await Promise.all(promises);
                results.forEach((data, index) => {
                    if (data) {
                        if (data.contents) try { data = JSON.parse(data.contents); } catch (e) { }
                        if (!data.SubRoute) return;
                        const dir = index < 2 ? 'down' : 'up';
                        if (!fetchedStops[dir] && data.SubRoute[0]?.TTE?.stops) fetchedStops[dir] = data.SubRoute[0].TTE.stops;
                        parseBusData(data, busMap, dir);
                    }
                });
                if (fetchedStops.down) state.routeStops.down = fetchedStops.down;
                if (fetchedStops.up) state.routeStops.up = fetchedStops.up;
                state.allBuses = Array.from(busMap.values());
                updateTracking(state.allBuses);
                updateStatus('ok');
                render();
            } catch (e) {
                state.proxyIndex = (state.proxyIndex + 1) % CONFIG.PROXIES.length;
                updateStatus('error');
            }
        }

        function parseBusData(data, busMap, direction) {
            const okDataMS = Date.now() - 1200000;
            data.SubRoute.forEach(sub => {
                if (!sub.Bus) return;
                sub.Bus.forEach(bus => {
                    if (!bus.a2 || /^TEST.*$/g.test(bus.num)) return;
                    if (bus.a1 && (bus.a1.split(',')[3] === "2" || bus.a1.split(',')[4] === "99")) return;
                    const parts = bus.a2.split(',');
                    if (parts.length <= 11 || parts[3] === "2" || parts[4] === "99" || parts[4] !== '0') return;
                    const timeStr = parts[11];
                    if (timeStr && timeStr.length >= 12) {
                        const busTime = Date.parse("20" + timeStr.substr(0, 2) + "-" + timeStr.substr(2, 2) + "-" + timeStr.substr(4, 2) + "T" + timeStr.substr(6, 2) + ":" + timeStr.substr(8, 2) + ":" + timeStr.substr(10, 2));
                        if (busTime < okDataMS) return;
                    }
                    const busStopId = parts[7];
                    if (parts[8] === "1" && FIRST_STOP_MAP[parts[5]] && busStopId == FIRST_STOP_MAP[parts[5]]) return;
                    busMap.set(bus.num, { plate: bus.num, stopId: busStopId, stopName: STOP_NAMES[busStopId] || `ç«™é» ${busStopId}`, time: Date.now(), direction: direction, a2: bus.a2, type: bus.type });
                });
            });
        }

        function updateTracking(currentBuses) {
            const now = Date.now();
            currentBuses.forEach(bus => {
                const plate = bus.plate;
                const stopId = bus.stopId;
                if (stopId === CONFIG.STOPS.DOWN_START) {
                    if (!state.tracking[plate] || state.tracking[plate].type !== 'down') state.tracking[plate] = { type: 'down', startTime: now, startStop: 'æ–‡åŒ–å¤§å­¸', lastUpdate: now, currentStop: bus.stopName, isWaiting: true };
                    else { state.tracking[plate].startTime = now; state.tracking[plate].lastUpdate = now; state.tracking[plate].isWaiting = true; }
                } else if (stopId === CONFIG.STOPS.UP_START) {
                    if (!state.tracking[plate] || state.tracking[plate].type !== 'up') state.tracking[plate] = { type: 'up', startTime: now, startStop: 'æ·é‹åŠæ½­ç«™', lastUpdate: now, currentStop: bus.stopName, isWaiting: true };
                    else { state.tracking[plate].startTime = now; state.tracking[plate].lastUpdate = now; state.tracking[plate].isWaiting = true; }
                } else if (state.tracking[plate]) {
                    const trip = state.tracking[plate];
                    trip.isWaiting = false; trip.lastUpdate = now; trip.currentStop = bus.stopName; trip.stopId = stopId;
                    if ((trip.type === 'down' && stopId === CONFIG.STOPS.DOWN_END) || (trip.type === 'up' && stopId === CONFIG.STOPS.UP_END)) completeTrip(plate, trip, now);
                }
            });
            for (let plate in state.tracking) { if (now - state.tracking[plate].lastUpdate > 1200000) delete state.tracking[plate]; }
            saveData();
        }

        function completeTrip(plate, trip, endTime) {
            const duration = ((endTime - trip.startTime) / 60000).toFixed(1);
            if (duration > 5 && duration < 120) {
                state.completed.unshift({ type: trip.type, plate: plate, startTime: trip.startTime, endTime: endTime, duration: duration, date: new Date().toLocaleString() });
                if (state.completed.length > 200) state.completed.pop();
            }
            delete state.tracking[plate];
        }

        function render() {
            const stops = state.routeStops[state.activeSidebar];
            const buses = state.allBuses.filter(b => b.direction === state.activeSidebar);
            renderTimeline(stops, buses);
            const downs = state.completed.filter(t => t.type === 'down');
            const ups = state.completed.filter(t => t.type === 'up');
            const calc = list => list.length ? (list.reduce((a, b) => a + parseFloat(b.duration), 0) / list.length).toFixed(1) : '--';
            document.getElementById('down-avg').textContent = calc(downs);
            document.getElementById('up-avg').textContent = calc(ups);
            document.getElementById('down-last').textContent = downs.length ? downs[0].duration : '--';
            document.getElementById('up-last').textContent = ups.length ? ups[0].duration : '--';
            document.getElementById('down-count').textContent = Object.values(state.tracking).filter(t => t.type === 'down' && !t.isWaiting).length;
            document.getElementById('up-count').textContent = Object.values(state.tracking).filter(t => t.type === 'up' && !t.isWaiting).length;
            renderTrackingList(document.getElementById('down-list'), Object.values(state.tracking).filter(v => v.type === 'down'), 'blue');
            renderTrackingList(document.getElementById('up-list'), Object.values(state.tracking).filter(v => v.type === 'up'), 'orange');
            renderHistory();
        }

        function renderTimeline(stops, buses) {
            const container = document.getElementById('sidebar-container');
            if (!stops || stops.length === 0) return;
            container.innerHTML = stops.map(stop => {
                const stopName = STOP_NAMES[stop.stopId] || `${stop.stopId}`;
                const stopTTE = stop.stopTTE;
                const sStopTTE = stopTTE.toString();
                let dotClass = 'bg-white border-slate-300', statusText = '', statusClass = 'text-slate-400', rowOpacity = 'opacity-100';
                if (TTE_MAP.hasOwnProperty(sStopTTE)) {
                    statusText = TTE_MAP[sStopTTE];
                    if (sStopTTE === '-2' || sStopTTE === '0') { statusClass = 'text-red-600 font-bold'; dotClass = 'bg-red-500 border-red-500 animate-pulse ring-2 ring-red-100'; }
                    else if (sStopTTE === '-4') { statusText = 'å·²éç«™'; rowOpacity = 'opacity-40'; dotClass = 'bg-slate-200 border-slate-200'; }
                } else {
                    if (stopTTE > 0 && stopTTE < 180) { statusText = 'å°‡åˆ°ç«™'; statusClass = 'text-orange-500 font-bold'; dotClass = 'bg-white border-orange-500'; }
                    else if (stopTTE >= 180) { statusText = `${Math.floor(stopTTE / 60)} åˆ†`; statusClass = 'text-blue-600 font-bold'; dotClass = 'bg-white border-blue-500'; }
                }
                const busHere = buses.find(b => b.a2 && b.a2.split(',')[7] == stop.stopId);
                const busHtml = busHere ? `<div class="absolute -top-7 left-3 z-20 bus-float"><div class="bg-yellow-400 text-slate-900 text-[10px] font-bold px-2 py-0.5 rounded shadow-md border border-yellow-500 whitespace-nowrap">ğŸšŒ ${busHere.plate}</div><div class="w-0 h-0 border-l-[4px] border-l-transparent border-r-[4px] border-r-transparent border-t-[6px] border-t-yellow-500 mx-auto"></div></div>` : '';
                if (busHere) rowOpacity = 'opacity-100';
                return `<div class="relative pl-10 pr-4 py-2 timeline-item ${rowOpacity} min-h-[50px] flex items-center"><div class="timeline-line"></div><div class="absolute left-4 w-3 h-3 rounded-full border-2 ${dotClass} z-10 bg-clip-padding box-border"></div>${busHtml}<div class="flex justify-between items-baseline w-full"><div class="text-sm font-medium text-slate-800">${stopName}</div><div class="text-[11px] ${statusClass}">${statusText}</div></div></div>`;
            }).join('');
        }

        function renderTrackingList(container, list, color) {
            container.innerHTML = list.length ? list.sort((a, b) => a.isWaiting - b.isWaiting || b.startTime - a.startTime).map(bus => {
                const elapsed = Math.max(0, Math.floor((Date.now() - bus.startTime) / 60000));
                const isWait = bus.isWaiting;
                return `<div class="bg-white p-3 rounded-lg border border-${color}-100 shadow-sm flex justify-between items-center ${isWait ? 'opacity-60' : ''}"><div class="font-bold text-slate-700">${bus.plate}</div><div class="text-right">${isWait ? '<span class="text-[10px] bg-slate-100 px-1 rounded text-slate-400">å¾…ç™¼è»Š</span>' : `<div class="font-mono font-black text-${color}-500 text-xl">${elapsed}<span class="text-[10px] font-normal text-slate-400">åˆ†</span></div>`}</div></div>`;
            }).join('') : `<div class="text-center text-slate-400 text-xs py-8 opacity-50">ç›®å‰ç„¡è»Šè¼›</div>`;
        }

        function renderHistory() {
            const tbody = document.getElementById('history-table-body');
            const empty = document.getElementById('history-empty');
            if (state.completed.length === 0) { tbody.innerHTML = ''; empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden');
            tbody.innerHTML = state.completed.map(trip => `<tr><td class="p-3"><span class="px-2 py-0.5 rounded text-[10px] font-bold ${trip.type === 'down' ? 'bg-blue-100 text-blue-600' : 'bg-orange-100 text-orange-600'}">${trip.type === 'down' ? 'ä¸‹å±±' : 'ä¸Šå±±'}</span><div class="font-mono font-bold text-slate-700 mt-1">${trip.plate}</div></td><td class="p-3 text-slate-500"><div class="text-[10px]">${new Date(trip.startTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div><div class="text-[10px] opacity-50">â†“</div><div class="text-[10px]">${new Date(trip.endTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div></td><td class="p-3 text-right font-bold text-slate-800">${trip.duration}åˆ†</td></tr>`).join('');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => { el.classList.remove('text-blue-600'); el.classList.add('text-slate-400'); });
            document.getElementById(`view-${tab}`).classList.add('active');
            if (event) { event.currentTarget.classList.remove('text-slate-400'); event.currentTarget.classList.add('text-blue-600'); }
        }
        function switchSidebar(dir) {
            state.activeSidebar = dir; const isDown = dir === 'down';
            document.getElementById('tab-down').className = `flex-1 py-2 text-xs font-bold rounded-md transition-all shadow-sm ${isDown ? 'bg-white text-blue-600' : 'text-slate-500 hover:text-slate-700'}`;
            document.getElementById('tab-up').className = `flex-1 py-2 text-xs font-bold rounded-md transition-all shadow-sm ${!isDown ? 'bg-white text-orange-600' : 'text-slate-500 hover:text-slate-700'}`;
            renderTimeline(state.routeStops[dir], state.allBuses.filter(b => b.direction === dir));
        }
        function updateStatus(s) {
            const el = document.getElementById('last-update-time'); if (el) el.textContent = s === 'loading' ? 'æ›´æ–°ä¸­...' : `æ›´æ–°æ–¼ ${new Date().toLocaleTimeString()}`;
            const mob = document.getElementById('mobile-status-text'); if (mob) mob.textContent = s === 'loading' ? 'æ›´æ–°ä¸­...' : new Date().toLocaleTimeString();
        }
        function saveData() { localStorage.setItem('red5_final_v2', JSON.stringify({ tracking: state.tracking, completed: state.completed })); }
        function loadData() { const raw = localStorage.getItem('red5_final_v2'); if (raw) { const d = JSON.parse(raw); state.tracking = d.tracking || {}; state.completed = d.completed || []; } }
        function exportCSV() {
            if (state.completed.length === 0) return alert('ç„¡è³‡æ–™');
            let csv = "æ–¹å‘,è»Šè™Ÿ,æ—¥æœŸ,é–‹å§‹,çµæŸ,è€—æ™‚(åˆ†)\n";
            state.completed.forEach(t => { csv += `${t.type === 'down' ? 'ä¸‹å±±' : 'ä¸Šå±±'},${t.plate},${t.date},${new Date(t.startTime).toLocaleTimeString()},${new Date(t.endTime).toLocaleTimeString()},${t.duration}\n`; });
            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `Red5_History_${new Date().toISOString().slice(0, 10)}.csv`; link.click();
        }
        window.switchTab = switchTab; window.switchSidebar = switchSidebar; window.exportCSV = exportCSV; init();
    </script>
</body>

</html>
