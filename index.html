<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç´…5 é›™å‘å³æ™‚ç›£æ¸¬ - æ–‡åŒ–å¤§å­¸ â‡„ æ·é‹åŠæ½­ç«™</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }
        .scroll-hide::-webkit-scrollbar { display: none; }
        .scroll-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* å…¬è»Šæ‡¸æµ®å‹•ç•« */
        .bus-float { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
        
        /* æ™‚é–“è»¸ç·šæ¢ */
        .timeline-line {
            position: absolute;
            left: 23px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #cbd5e1; /* é¡è‰²åŠ æ·± */
            z-index: 0;
        }
    </style>
</head>
<body class="text-slate-900 h-screen flex overflow-hidden">

    <!-- Left Sidebar -->
    <aside class="w-80 bg-white flex flex-col shrink-0 z-20 shadow-xl border-r border-slate-300">
        <div class="p-4 border-b border-slate-200 bg-slate-50">
            <div class="flex items-center gap-3 mb-3">
                <span class="bg-red-600 text-white font-bold px-2 py-0.5 rounded text-sm tracking-wider">ç´…5</span>
                <h1 class="font-bold text-lg text-slate-800">å…¨ç·šå‹•æ…‹</h1>
            </div>
            <!-- Tabs -->
            <div class="flex bg-slate-200 p-1 rounded-lg">
                <button id="tab-down" onclick="switchSidebar('down')" class="flex-1 py-2 text-sm font-bold rounded-md transition-all bg-white text-blue-700 shadow-sm border border-slate-200">å¾€ åŠæ½­ (ä¸‹å±±)</button>
                <button id="tab-up" onclick="switchSidebar('up')" class="flex-1 py-2 text-sm font-bold rounded-md transition-all text-slate-600 hover:text-slate-900 hover:bg-slate-100">å¾€ æ–‡å¤§ (ä¸Šå±±)</button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto relative scroll-hide bg-white" id="sidebar-container">
            <div class="p-10 text-center text-slate-500 text-sm">è¼‰å…¥ä¸­...</div>
        </div>

        <div class="p-3 border-t border-slate-200 bg-slate-50 text-xs text-slate-600 flex justify-between items-center px-4 font-medium">
            <span id="last-update-time">é€£ç·šä¸­...</span>
            <span id="connection-status" class="flex h-2.5 w-2.5"><span class="animate-ping absolute inline-flex h-2.5 w-2.5 rounded-full bg-emerald-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-emerald-600"></span></span>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full relative bg-slate-100">
        
        <!-- Dashboard Header -->
        <header class="bg-white border-b border-slate-200 p-6 shadow-sm z-10">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Downhill Card -->
                <div class="bg-white border border-blue-200 rounded-xl p-5 relative overflow-hidden shadow-sm">
                    <div class="absolute top-0 right-0 bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded-bl-lg">ä¸‹å±± (æ–‡å¤§â”åŠæ½­)</div>
                    <div class="flex justify-between items-end mt-2">
                        <div>
                            <div class="flex items-baseline gap-1">
                                <span class="text-5xl font-black text-blue-700 tracking-tight" id="down-avg">--</span>
                                <span class="text-base text-blue-600 font-bold">åˆ†</span>
                            </div>
                            <div class="text-xs text-slate-500 mt-1 font-bold">å¹³å‡è¡Œé§›æ™‚é–“</div>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-bold text-slate-800" id="down-count">0</div>
                            <div class="text-xs text-slate-500 font-bold">è¡Œé§›ä¸­</div>
                        </div>
                    </div>
                </div>
                <!-- Uphill Card -->
                <div class="bg-white border border-orange-200 rounded-xl p-5 relative overflow-hidden shadow-sm">
                    <div class="absolute top-0 right-0 bg-orange-500 text-white text-xs font-bold px-3 py-1 rounded-bl-lg">ä¸Šå±± (åŠæ½­â”æ–‡å¤§)</div>
                    <div class="flex justify-between items-end mt-2">
                        <div>
                            <div class="flex items-baseline gap-1">
                                <span class="text-5xl font-black text-orange-600 tracking-tight" id="up-avg">--</span>
                                <span class="text-base text-orange-500 font-bold">åˆ†</span>
                            </div>
                            <div class="text-xs text-slate-500 mt-1 font-bold">å¹³å‡è¡Œé§›æ™‚é–“</div>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-bold text-slate-800" id="up-count">0</div>
                            <div class="text-xs text-slate-500 font-bold">è¡Œé§›ä¸­</div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Lists Container -->
        <div class="flex-1 grid grid-cols-1 md:grid-cols-2 overflow-hidden">
            <section class="border-r border-slate-200 flex flex-col h-full bg-slate-50">
                <div class="px-4 py-3 bg-white border-b border-slate-200 text-sm font-bold text-slate-700 sticky top-0 shadow-sm z-10 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-blue-600"></span> ğŸ“‰ ä¸‹å±±è¿½è¹¤åˆ—è¡¨
                </div>
                <div class="flex-1 overflow-y-auto p-4 scroll-hide space-y-3" id="down-list"></div>
            </section>
            <section class="flex flex-col h-full bg-slate-50">
                <div class="px-4 py-3 bg-white border-b border-slate-200 text-sm font-bold text-slate-700 sticky top-0 shadow-sm z-10 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-orange-500"></span> ğŸ“ˆ ä¸Šå±±è¿½è¹¤åˆ—è¡¨
                </div>
                <div class="flex-1 overflow-y-auto p-4 scroll-hide space-y-3" id="up-list"></div>
            </section>
        </div>

        <!-- Footer -->
        <div class="bg-white border-t border-slate-200 p-3 px-4 flex justify-between items-center shrink-0 text-xs">
            <button id="reset-btn" class="text-slate-500 hover:text-red-600 font-bold px-2">æ¸…é™¤è¨˜éŒ„</button>
            <button id="export-btn" class="bg-slate-800 hover:bg-slate-900 text-white px-4 py-2 rounded font-bold shadow-sm transition-colors">ğŸ“¥ ä¸‹è¼‰ CSV å ±è¡¨</button>
        </div>
    </main>

    <script>
        // --- Config ---
        const CONFIG = {
            API_URLS: [
                'https://pda5284.gov.taipei/MQS/SubRouteDyna?csvsubrouteid=158420', // ä¸‹å±± 1
                'https://pda5284.gov.taipei/MQS/SubRouteDyna?csvsubrouteid=157609', // ä¸‹å±± 2
                'https://pda5284.gov.taipei/MQS/SubRouteDyna?csvsubrouteid=158419', // ä¸Šå±± 1
                'https://pda5284.gov.taipei/MQS/SubRouteDyna?csvsubrouteid=157610'  // ä¸Šå±± 2
            ],
            PROXIES: [
                'https://corsproxy.io/?',
                'https://api.allorigins.win/raw?url=',
                'https://cors-anywhere.herokuapp.com/'
            ],
            REFRESH_MS: 3000,
            STOPS: {
                DOWN_START: '11073', DOWN_END: '11121',
                UP_START: '11123', UP_END: '11169'
            }
        };

        // å®˜æ–¹é‚è¼¯å°ç…§è¡¨
    const TTE_MAP = {'0':'é€²ç«™ä¸­','':'æœªç™¼è»Š','-1':'æœªç™¼è»Š','-2':'äº¤ç®¡ä¸åœ','-3':'æœ«ç­å·²é','-4':'ä»Šæ—¥æœªç‡Ÿé‹'};
    const FIRST_STOP_MAP = {"158420":"174781", "157609":"174781", "158419":"134539", "157610":"134539"};

        const STOP_NAMES = {
            '174781': 'é™½æ˜å±±ç¸½ç«™', '11053': 'é™½æ˜å±±', '125818': 'ä¸­å±±æ¨“', '11057': 'æ•™å¸«ä¸­å¿ƒ',
            '11059': 'è¯å‹¤é™½æ˜å±±æ‹›å¾…æ‰€', '11061': 'ç¦å£½æ©‹', '11063': 'æ ¼è‡´å¤§äº¨è·¯å£', '11065': 'ç£ºæºªåº•',
            '58228': 'æ–‡åŒ–å¤§å­¸ä¸€', '11071': 'é™½æ˜å¤©ä¸»å ‚', '11073': 'æ–‡åŒ–å¤§å­¸', '11075': 'å±±ä»”åæ´¾å‡ºæ‰€',
            '11077': 'æ ¼è‡´åœ‹ä¸­', '11079': 'ä¸‹ç«¹æ—', '11081': 'æ–°å®‰', '11083': 'ç™½é›²å±±èŠ',
            '11085': 'æ˜å¾·æ–°æ‘', '11087': 'é™½æ˜å±±åœ‹å°', '11089': 'ç¦éŸ³', '11091': 'é™½æ˜æ•™é¤Šé™¢',
            '11093': 'æ°¸ç¦(æ—èªå ‚æ•…å±…)', '11095': 'æ°¸å¶º', '11097': 'æ‹”å­åŸ”', '11099': 'å¶ºé ­',
            '11101': 'è¯èˆˆä¸­å­¸', '11103': 'èŠè˜­æ–°æ‘', '11105': 'å²©å±±é‡Œä¸€', '11107': 'å²©å±±é‡Œ',
            '11109': 'æ³°åŒ—ä¸­å­¸', '11111': 'å£«æ—å®˜é‚¸(ä¸­æ­£)', '11113': 'ç¦æ—åœ‹å°', '11115': 'æ·é‹å£«æ—ç«™',
            '11117': 'å°é›»å°åŒ—åŒ—å€ç‡Ÿæ¥­è™•', '11119': 'éŠ˜å‚³å¤§å­¸', '11121': 'æ·é‹åŠæ½­ç«™',
            '11123': 'æ·é‹åŠæ½­ç«™(åŒ—è—ä¸­å¿ƒ)', '11125': 'å°åŒ—è¡—', '11051': 'å£«æ—å€è¾²æœƒ', '11127': 'æ·é‹å£«æ—ç«™(ä¸­æ­£)',
            '11129': 'ç¦æ—åœ‹å°', '11131': 'å£«æ—å®˜é‚¸(ä¸­æ­£)', '11133': 'æ³°åŒ—ä¸­å­¸', '11135': 'å²©å±±é‡Œ',
            '11137': 'å²©å±±é‡Œä¸€', '11139': 'èŠè˜­æ–°æ‘', '11141': 'è¯èˆˆä¸­å­¸', '11143': 'å¶ºé ­',
            '11145': 'æ‹”å­åŸ”', '11147': 'æ°¸å¶º', '11149': 'æ°¸ç¦(æ—èªå ‚æ•…å±…)', '11151': 'é™½æ˜æ•™é¤Šé™¢',
            '11153': 'ç¦éŸ³', '11155': 'é™½æ˜å±±åœ‹å°', '11157': 'æ˜å¾·æ–°æ‘', '11159': 'ç™½é›²å±±èŠ',
            '11161': 'æ–°å®‰', '11163': 'ä¸‹ç«¹æ—', '11165': 'æ ¼è‡´åœ‹ä¸­', '11167': 'å±±ä»”åæ´¾å‡ºæ‰€',
            '11169': 'æ–‡åŒ–å¤§å­¸', '11173': 'æ–‡åŒ–å¤§å­¸ä¸€', '11175': 'é™½æ˜å¤©ä¸»å ‚', '11177': 'ç£ºæºªåº•',
            '11179': 'æ ¼è‡´å¤§äº¨è·¯å£', '11181': 'ç¦å£½æ©‹', '11183': 'è¯å‹¤é™½æ˜å±±æ‹›å¾…æ‰€', '11055': 'éŒ«å®‰å ‚',
            '11185': 'æ•™å¸«ä¸­å¿ƒ', '125817': 'ä¸­å±±æ¨“', '57747': 'é™½æ˜å±±', '11187': 'é™½æ˜å±±ç¸½ç«™'
        };

        // --- State ---
        let state = {
            tracking: {},
            completed: [],
            proxyIndex: 0,
            allBuses: [],
            routeStops: { down: [], up: [] },
            activeSidebar: 'down'
        };

        // --- DOM ---
        const els = {
            sidebarContainer: document.getElementById('sidebar-container'),
            downList: document.getElementById('down-list'),
            upList: document.getElementById('up-list'),
            downAvg: document.getElementById('down-avg'),
            upAvg: document.getElementById('up-avg'),
            downCount: document.getElementById('down-count'),
            upCount: document.getElementById('up-count'),
            statusDot: document.getElementById('connection-status').querySelector('span'),
            statusText: document.getElementById('last-update-time'),
            tabDown: document.getElementById('tab-down'),
            tabUp: document.getElementById('tab-up')
        };

        // --- Init ---
        function init() {
            loadData();
            fetchData();
            setInterval(fetchData, CONFIG.REFRESH_MS);
            document.getElementById('reset-btn').addEventListener('click', () => {
                if(confirm('ç¢ºå®šæ¸…é™¤æ‰€æœ‰è¨˜éŒ„ï¼Ÿ')) { state.tracking = {}; state.completed = []; saveData(); render(); }
            });
            document.getElementById('export-btn').addEventListener('click', exportCSV);
        }

        // --- Fetch & Parse ---
        async function fetchData() {
            updateStatus('loading');
            const proxy = CONFIG.PROXIES[state.proxyIndex];
            const busMap = new Map();
            let fetchedStops = { down: null, up: null };

            try {
                const promises = CONFIG.API_URLS.map(url => 
                    fetch(proxy + encodeURIComponent(url)).then(r => r.ok ? r.json() : null).catch(e => null)
                );
                const results = await Promise.all(promises);

                results.forEach((data, index) => {
                    if (data) {
                        if(data.contents) try{ data = JSON.parse(data.contents); }catch(e){}
                        if (!data.SubRoute) return;
                        const dir = index < 2 ? 'down' : 'up';
                        if (!fetchedStops[dir] && data.SubRoute[0]?.TTE?.stops) fetchedStops[dir] = data.SubRoute[0].TTE.stops;
                        parseBusData(data, busMap, dir);
                    }
                });

                if (fetchedStops.down) state.routeStops.down = fetchedStops.down;
                if (fetchedStops.up) state.routeStops.up = fetchedStops.up;
                
                state.allBuses = Array.from(busMap.values());
                updateTracking(state.allBuses);
                updateStatus('ok');
                render();

            } catch (e) {
                console.error(e);
                state.proxyIndex = (state.proxyIndex + 1) % CONFIG.PROXIES.length;
                updateStatus('error');
            }
        }

        function parseBusData(data, busMap, direction) {
            const okDataMS = Date.now() - 1200000; 
            data.SubRoute.forEach(sub => {
                if (!sub.Bus) return;
                sub.Bus.forEach(bus => {
                    if (!bus.a2) return;
                    if (/^TEST.*$/g.test(bus.num)) return;
                    if (bus.a1) {
                        const arrA1 = bus.a1.split(',');
                        if (arrA1[3] === "2" || arrA1[4] === "99") return;
                    }
                    const arrA2 = bus.a2.split(',');
                    if (arrA2.length <= 11) return;
                    if (arrA2[3] === "2" || arrA2[4] === "99") return;
                    const timeStr = arrA2[11];
                    if (timeStr && timeStr.length >= 12) {
                         const busTime = Date.parse("20"+timeStr.substr(0,2)+"-"+timeStr.substr(2,2)+"-"+timeStr.substr(4,2)+"T"+timeStr.substr(6,2)+":"+timeStr.substr(8,2)+":"+timeStr.substr(10,2));
                         if (busTime < okDataMS) return;
                    }
                    const busStopId = arrA2[7];
                    busMap.set(bus.num, {
                        plate: bus.num,
                        stopId: busStopId,
                        stopName: STOP_NAMES[busStopId] || `ç«™é» ${busStopId}`,
                        time: Date.now(),
                        direction: direction,
                        a2: bus.a2,
                        type: bus.type
                    });
                });
            });
        }

        // --- Tracking Logic ---
        function updateTracking(currentBuses) {
            const now = Date.now();
            currentBuses.forEach(bus => {
                const plate = bus.plate;
                const stopId = bus.stopId;

                if (stopId === CONFIG.STOPS.DOWN_START) {
                    if (!state.tracking[plate] || state.tracking[plate].type !== 'down') {
                        state.tracking[plate] = { type: 'down', startTime: now, startStop: 'æ–‡åŒ–å¤§å­¸', lastUpdate: now, currentStop: bus.stopName, isWaiting: true };
                    } else {
                        state.tracking[plate].startTime = now; 
                        state.tracking[plate].isWaiting = true;
                        state.tracking[plate].lastUpdate = now;
                    }
                }
                else if (stopId === CONFIG.STOPS.UP_START) {
                    if (!state.tracking[plate] || state.tracking[plate].type !== 'up') {
                        state.tracking[plate] = { type: 'up', startTime: now, startStop: 'æ·é‹åŠæ½­ç«™', lastUpdate: now, currentStop: bus.stopName, isWaiting: true };
                    } else {
                        state.tracking[plate].startTime = now;
                        state.tracking[plate].isWaiting = true;
                        state.tracking[plate].lastUpdate = now;
                    }
                }
                else if (state.tracking[plate]) {
                    const trip = state.tracking[plate];
                    trip.isWaiting = false;
                    trip.lastUpdate = now;
                    trip.currentStop = bus.stopName;
                    trip.stopId = stopId;
                    if ((trip.type === 'down' && stopId === CONFIG.STOPS.DOWN_END) || 
                        (trip.type === 'up' && stopId === CONFIG.STOPS.UP_END)) {
                        completeTrip(plate, trip, now);
                    }
                }
            });
            for (let plate in state.tracking) {
                if (now - state.tracking[plate].lastUpdate > 1200000) delete state.tracking[plate];
            }
            saveData();
        }

        function completeTrip(plate, trip, endTime) {
            const duration = ((endTime - trip.startTime) / 60000).toFixed(1);
            if (duration > 5 && duration < 120) {
                state.completed.unshift({
                    type: trip.type,
                    plate: plate,
                    startTime: trip.startTime,
                    endTime: endTime,
                    duration: duration,
                    date: new Date().toLocaleString()
                });
                if (state.completed.length > 100) state.completed.pop();
            }
            delete state.tracking[plate];
        }

        // --- Render ---
        function render() {
            renderSidebar();
            renderDashboard();
            renderTrackingLists();
        }

        function switchSidebar(dir) {
            state.activeSidebar = dir;
            if (dir === 'down') {
                els.tabDown.className = "flex-1 py-2 text-sm font-bold rounded-md transition-all bg-white text-blue-700 shadow-sm border border-slate-200";
                els.tabUp.className = "flex-1 py-2 text-sm font-bold rounded-md transition-all text-slate-600 hover:text-slate-900 hover:bg-slate-100";
            } else {
                els.tabDown.className = "flex-1 py-2 text-sm font-bold rounded-md transition-all text-slate-600 hover:text-slate-900 hover:bg-slate-100";
                els.tabUp.className = "flex-1 py-2 text-sm font-bold rounded-md transition-all bg-white text-orange-600 shadow-sm border border-slate-200";
            }
            renderSidebar();
        }

        function renderSidebar() {
            const stops = state.routeStops[state.activeSidebar];
            const buses = state.allBuses.filter(b => b.direction === state.activeSidebar);
            
            if (!stops || stops.length === 0) {
                els.sidebarContainer.innerHTML = `<div class="p-10 text-center text-slate-500 text-sm">è¼‰å…¥ä¸­...</div>`;
                return;
            }

            const html = stops.map((stop, index) => {
                const stopName = STOP_NAMES[stop.stopId] || `ç«™é» ${stop.stopId}`;
                const stopTTE = stop.stopTTE;
                
                const busHere = buses.find(b => {
                    if (!b.a2) return false;
                    return b.a2.split(',')[7] == stop.stopId;
                });

                // è¦–è¦ºæ¨£å¼è¨­å®š
                let dotClass = 'bg-white border-slate-400';
                let textClass = 'text-slate-800 font-medium';
                let statusText = '';
                let statusColor = 'text-slate-500';
                
                // ç§»é™¤ Opacityï¼Œæ”¹ç”¨é¡è‰²å€åˆ†
                const sStopTTE = stopTTE.toString();
                
                if (TTE_MAP.hasOwnProperty(sStopTTE)) {
                    statusText = TTE_MAP[sStopTTE];
                    if (sStopTTE === '-2' || sStopTTE === '0') { 
                        statusColor = 'text-red-600 font-bold';
                        dotClass = 'bg-red-600 border-red-600 animate-pulse ring-4 ring-red-100';
                        textClass = 'text-red-700 font-bold';
                    } else if (sStopTTE === '-4') {
                        statusText = 'å·²éç«™';
                        statusColor = 'text-slate-400'; // æ–‡å­—è®Šç°
                        textClass = 'text-slate-400';   // ç«™åè®Šç°
                        dotClass = 'bg-slate-200 border-slate-300';
                    } else if (sStopTTE === '3') {
                        statusText = 'äº¤ç®¡ä¸åœ';
                        statusColor = 'text-orange-600 font-bold';
                        dotClass = 'bg-orange-100 border-orange-500';
                        textClass = 'text-slate-600';
                    }
                } else {
                    if (stopTTE > 0 && stopTTE < 180) {
                        statusText = 'å°‡åˆ°ç«™';
                        statusColor = 'text-orange-600 font-bold';
                        dotClass = 'bg-white border-orange-500';
                    } else if (stopTTE >= 180) {
                        const min = Math.floor(stopTTE / 60);
                        statusText = `${min} åˆ†`;
                        statusColor = 'text-blue-700 font-bold';
                        dotClass = 'bg-white border-blue-600';
                    } else {
                        statusText = 'ç­‰å¾…ä¸­';
                        statusColor = 'text-slate-400';
                    }
                }

                let busHtml = '';
                if (busHere) {
                    busHtml = `
                        <div class="absolute -top-3 left-3 z-20 bus-float pointer-events-none">
                            <div class="bg-yellow-400 text-slate-900 text-[11px] font-bold px-2 py-0.5 rounded shadow-md border border-yellow-500 flex items-center gap-1 whitespace-nowrap">
                                ğŸšŒ ${busHere.plate}
                            </div>
                            <div class="w-0 h-0 border-l-[5px] border-l-transparent border-r-[5px] border-r-transparent border-t-[6px] border-t-yellow-500 mx-auto"></div>
                        </div>
                    `;
                }

                return `
                    <div class="relative pl-10 pr-4 py-3 timeline-item">
                        <div class="timeline-line"></div>
                        <div class="absolute left-4 top-4 w-3.5 h-3.5 rounded-full border-[3px] ${dotClass} z-10 bg-clip-padding box-border"></div>
                        ${busHtml}
                        <div class="flex justify-between items-baseline">
                            <div class="text-base ${textClass}">${stopName}</div>
                            <div class="text-xs ${statusColor}">${statusText}</div>
                        </div>
                    </div>
                `;
            }).join('');

            els.sidebarContainer.innerHTML = html;
        }

        function renderDashboard() {
            const downs = state.completed.filter(t => t.type === 'down');
            const ups = state.completed.filter(t => t.type === 'up');
            els.downAvg.textContent = calcAvg(downs);
            els.upAvg.textContent = calcAvg(ups);

            const activeDown = Object.values(state.tracking).filter(t => t.type === 'down' && !t.isWaiting).length;
            const activeUp = Object.values(state.tracking).filter(t => t.type === 'up' && !t.isWaiting).length;
            els.downCount.textContent = activeDown;
            els.upCount.textContent = activeUp;
        }

        function renderTrackingLists() {
            const activeDown = Object.entries(state.tracking).filter(([k,v]) => v.type === 'down').map(([k,v]) => ({plate:k, ...v}));
            const activeUp = Object.entries(state.tracking).filter(([k,v]) => v.type === 'up').map(([k,v]) => ({plate:k, ...v}));
            
            renderList(els.downList, activeDown, 'blue');
            renderList(els.upList, activeUp, 'orange');
        }

        function renderList(container, list, color) {
            if(list.length === 0) {
                container.innerHTML = `<div class="text-center text-slate-400 text-sm py-10">ç›®å‰ç„¡è»Šè¼›</div>`;
                return;
            }
            
            const html = list.sort((a,b) => a.isWaiting - b.isWaiting || b.startTime - a.startTime).map(bus => {
                let elapsed = Math.floor((Date.now() - bus.startTime) / 60000);
                if (elapsed < 0) elapsed = 0;
                
                let timeHtml = bus.isWaiting 
                    ? `<span class="text-xs bg-slate-200 text-slate-600 px-2 py-1 rounded font-bold">â³ å¾…ç™¼è»Š</span>`
                    : `<div class="font-mono font-black text-${color}-600 text-xl">${elapsed}<span class="text-xs ml-0.5 font-normal text-slate-500">åˆ†</span></div>`;
                
                let rowClass = bus.isWaiting ? 'opacity-75' : 'animate-in fade-in slide-in-from-bottom-1';

                return `
                    <div class="bg-white p-4 rounded-lg border border-${color}-200 shadow-sm flex justify-between items-center ${rowClass} mb-3 transition-all hover:shadow-md">
                        <div>
                            <div class="font-bold text-slate-800 flex items-center gap-2 text-lg">
                                ${bus.plate}
                                ${!bus.isWaiting ? `<span class="w-2 h-2 rounded-full bg-${color}-500 animate-pulse"></span>` : ''}
                            </div>
                            <div class="text-xs text-slate-500 mt-1 truncate max-w-[140px] font-medium">ğŸ“ ${bus.currentStop}</div>
                        </div>
                        <div class="text-right">${timeHtml}</div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        function calcAvg(list) {
            if (list.length === 0) return '--';
            const recent = list.slice(0, 20);
            const total = recent.reduce((sum, t) => sum + parseFloat(t.duration), 0);
            return (total / recent.length).toFixed(1);
        }

        function updateStatus(s) {
            const now = new Date().toLocaleTimeString();
            els.statusText.textContent = s === 'loading' ? 'æ›´æ–°ä¸­...' : `æ›´æ–°æ–¼ ${now}`;
            if(s==='ok') els.statusDot.className = 'relative inline-flex rounded-full h-2.5 w-2.5 bg-emerald-600';
            else if(s==='loading') els.statusDot.className = 'relative inline-flex rounded-full h-2.5 w-2.5 bg-amber-500 animate-pulse';
            else els.statusDot.className = 'relative inline-flex rounded-full h-2.5 w-2.5 bg-rose-600';
        }

        function saveData() { localStorage.setItem('red5_full_v5', JSON.stringify({ tracking: state.tracking, completed: state.completed })); }
        function loadData() {
            const raw = localStorage.getItem('red5_full_v5');
            if (raw) { const d = JSON.parse(raw); state.tracking = d.tracking || {}; state.completed = d.completed || []; }
        }
        function exportCSV() {
            if (state.completed.length === 0) return alert('ç„¡è³‡æ–™');
            let csv = "æ–¹å‘,è»Šè™Ÿ,æ—¥æœŸ,é–‹å§‹,çµæŸ,è€—æ™‚(åˆ†)\n";
            state.completed.forEach(t => {
                csv += `${t.type==='down'?'ä¸‹å±±':'ä¸Šå±±'},${t.plate},${t.date},${new Date(t.startTime).toLocaleTimeString()},${new Date(t.endTime).toLocaleTimeString()},${t.duration}\n`;
            });
            const blob = new Blob(["\uFEFF"+csv], {type: 'text/csv;charset=utf-8;'});
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob);
            link.download = `Red5_Export_${new Date().toISOString().slice(0,10)}.csv`; link.click();
        }

        window.switchSidebar = switchSidebar;
        init();
    </script>
</body>
</html>
